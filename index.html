<!DOCTYPE html>
<html lang="en" data-theme="hackercyan">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>RESELLr</title>
<link rel="icon" href="./favicon.png">

<!-- PWA -->
<link rel="manifest" href="./manifest.webmanifest">
<meta name="theme-color" content="#38bdf8">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="RESELLr">
<link rel="apple-touch-icon" href="./icons/icon-192.png">

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>

.login-brand{
  display:flex;
  justify-content:center;
  margin: 10px 0 14px 0;
}
.login-logo{
  width: 420px;        /* adjust */
  max-width: 92%;
  height: auto;
  filter: drop-shadow(0 10px 30px rgba(0,0,0,.45));
}

:root{
  --green:#22c55e;
  --red:#ef4444;
  --yellow:#fbbf24;
}

html[data-theme="hackercyan"]{
  --bg:#03060a;
  --panel:rgba(10,16,24,0.78);
  --panel-solid:#0a1018;
  --border:rgba(56,189,248,0.22);
  --text:#e5f0ff;
  --muted:#7b8ca3;

  --accent:#38bdf8;
  --accent-2:#22d3ee;
  --blue:#38bdf8;
}


html[data-theme="cyberred"]{
  --bg:#040404;
  --panel:rgba(10,10,12,0.78);
  --panel-solid:#0a0a0c;
  --border:rgba(255,77,77,0.22);
  --text:#eaeaea;
  --muted:#8f8f95;

  --accent:#ff4d4d;
  --accent-2:#ff7a7a;
  --blue:#8b5cf6;
  --red:#ff4d4d;
}

[data-theme="monochrome"]{
  --bg:#000000;
  --panel:rgba(255,255,255,0.04);
  --panel-2:rgba(255,255,255,0.06);
  --border:rgba(255,255,255,0.18);
  --text:#f3f4f6;
  --muted:rgba(243,244,246,0.68);
  --accent:#ffffff;
  --accent-2:#a3a3a3;
  --blue:#ffffff;
  --green:#a3a3a3;
  --red:#ffffff;
}






* { box-sizing: border-box; }

body {
  margin: 0;
  font-family: "JetBrains Mono","Fira Code",monospace;
  background: var(--bg);
  color: var(--text);
  padding: 16px;
}

label { font-size: 12px; color: var(--muted); }

input, select, textarea {
  width: 100%;
  background: transparent;
  border: 1px solid var(--border);
  color: var(--text);
  padding: 9px 10px;
  margin: 6px 0 14px;
  font-family: inherit;
  font-size: 14px;
  border-radius: 10px;
}

input:focus, select:focus, textarea:focus { outline: none; border-color: var(--accent); }

/* Year dropdown text fix */
select { background-color: var(--panel); color: var(--text); }
select option { background-color: var(--panel); color: var(--text); }

button {
  width: 100%;
  background: transparent;
  border: 1px solid var(--accent);
  color: var(--accent);
  padding: 10px;
  border-radius: 12px;
  font-family: inherit;
  font-size: 14px;
  cursor: pointer;
}

button:hover { background: rgba(56,189,248,0.08); }
button.danger { border-color: var(--red); color: var(--red); }
button.danger:hover { background: rgba(239,68,68,0.08); }
button.small { width: auto; padding: 8px 10px; border-radius: 10px; }

.panel {
  background: var(--panel);
  border: 1px solid var(--border);
  padding: 16px;
  border-radius: 16px;
}

.panel h3 {
  margin: 0 0 12px;
  font-size: 13px;
  letter-spacing: 1px;
  color: var(--accent);
  text-transform: uppercase;
}

.grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
  gap: 16px;
}

.stat { font-size: 14px; margin-top: 6px; }
.green { color: var(--green); }
.blue { color: var(--accent); }
.yellow { color: var(--yellow); }
.red { color: var(--red); }
.muted { color: var(--muted); }

.divider { height: 1px; background: var(--border); margin: 12px 0; }

/* Charts */
.chart-wrap { width: 100%; height: 260px; position: relative; }
.chart-wrap canvas { width: 100% !important; height: 100% !important; }

/* ===== LOGIN OVERLAY ===== */
#lockScreen {
  position: fixed;
  inset: 0;
  background: rgba(10,14,20,0.96);
  display: none;
  align-items: center;
  justify-content: center;
  padding: 16px;
  z-index: 9999;
}
.lockBox {
  width: 100%;
  max-width: 460px;
  background: var(--panel);
  border: 1px solid var(--border);
  padding: 16px;
  border-radius: 18px;
}
.lockTitle {
  color: var(--accent);
  letter-spacing: 1px;
  text-transform: uppercase;
  font-size: 13px;
  margin: 0 0 10px;
}
.lockHint {
  color: var(--muted);
  font-size: 12px;
  margin: 0 0 14px;
  line-height: 1.4;
}
.lockMsg { font-size: 12px; color: var(--muted); margin-top: 10px; }

/* Collapsible */
.collapse-header {
  display: flex; align-items: center; justify-content: space-between;
  cursor: pointer; user-select: none; padding: 8px 0;
}
.collapse-header span {
  color: var(--accent);
  letter-spacing: 1px;
  text-transform: uppercase;
  font-size: 13px;
}
.caret { transition: transform 0.2s ease; color: var(--muted); font-size: 14px; }
.caret.open { transform: rotate(180deg); }
.collapse-body { display: none; padding-top: 8px; }

/* ===== CALCULATOR ===== */
.calc-half { max-width: 560px; justify-self: start; }
.calc-display {
  border: 1px solid var(--border);
  padding: 10px;
  margin-bottom: 10px;
  background: transparent;
  font-size: 16px;
  min-height: 42px;
  display: flex;
  align-items: center;
  justify-content: flex-end;
  overflow-x: auto;
  border-radius: 12px;
}
.calc-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; }
.calc-btn {
  border: 1px solid var(--border);
  color: var(--text);
  background: transparent;
  padding: 10px;
  cursor: pointer;
  font-family: inherit;
  font-size: 14px;
  border-radius: 12px;
}
.calc-btn:hover { background: rgba(56,189,248,0.06); border-color: var(--accent); }
.calc-btn.op { color: var(--accent); border-color: rgba(56,189,248,0.4); }
.calc-btn.danger { color: var(--red); border-color: rgba(239,68,68,0.5); }
.calc-btn.eq { color: var(--green); border-color: rgba(34,197,94,0.5); }

/* ===== Tables ===== */
.table-wrap { overflow: auto; border: 1px solid var(--border); border-radius: 14px; }
table { width: 100%; border-collapse: collapse; min-width: 820px; }
th, td { padding: 10px 10px; border-bottom: 1px solid rgba(31,41,55,0.65); font-size: 13px; }
th { text-align: left; color: var(--muted); font-weight: 600; background: rgba(31,41,55,0.18); position: sticky; top: 0; }
td { color: var(--text); }
tr:hover td { background: rgba(56,189,248,0.04); }
.action-cell { text-align: center; width: 46px; }
.trash { cursor: pointer; user-select: none; opacity: 0.9;  color: var(--red); }
.trash:hover { opacity: 1; }

/* ===== App Shell ===== */
.app {
  display: grid;
  grid-template-columns: 260px 1fr;
  gap: 16px;
  max-width: 1280px;
  margin: 0 auto;
}
.app.sidebar-closed { grid-template-columns: 1fr; }
.app.sidebar-closed .sidebar { display: none; }

.sidebar {
  position: sticky;
  top: 12px;
  align-self: start;
  height: calc(100vh - 24px);
  background: var(--panel);
  border: 1px solid var(--border);
  padding: 14px;
  display: flex;
  flex-direction: column;
  gap: 10px;
  border-radius: 16px;
}
.brand {
  display: flex; align-items: center; justify-content: space-between;
  padding-bottom: 10px; border-bottom: 1px solid var(--border); margin-bottom: 6px;
}
.brand .name {
  color: var(--accent);
  letter-spacing: 1px;
  text-transform: uppercase;
  font-size: 13px;
}
.nav { display: flex; flex-direction: column; gap: 8px; }
.nav button {
  width: 100%;
  text-align: left;
  padding: 10px 12px;
  border: 1px solid var(--border);
  color: var(--text);
  background: transparent;
  border-radius: 12px;
}
.nav button:hover { border-color: var(--accent); background: rgba(56,189,248,0.06); }
.nav button.active { border-color: var(--accent); color: var(--accent); background: rgba(56,189,248,0.08); }

.canvas { min-width: 0; }

.topbar {
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 12px;
  margin-bottom: 14px;
  padding: 12px 12px;
  background: var(--panel);
  border: 1px solid var(--border);
  border-radius: 16px;
  position: sticky;
  top: 12px;
  z-index: 30;
}
.topbar .title {
  color: var(--accent);
  text-transform: uppercase;
  letter-spacing: 1px;
  font-size: 13px;
}
.hamburger { width: auto; padding: 8px 10px; }

.section { display: none; }
.section.active { display: block; }

/* Mobile drawer mode */
@media (max-width: 900px) {
  body { padding: 12px; }
  .app { grid-template-columns: 1fr; }
  .app.sidebar-closed { grid-template-columns: 1fr; }
  .app.sidebar-closed .sidebar { display: flex; }

  .sidebar {
    position: fixed;
    inset: 0 auto 0 0;
    width: 82vw;
    max-width: 340px;
    height: 100vh;
    z-index: 9998;
    transform: translateX(-110%);
    transition: transform 0.18s ease;
    border-left: none;
    top: 0;
    align-self: unset;
    border-radius: 0 16px 16px 0;
  }
  .sidebar.open { transform: translateX(0); }

  .drawer-scrim {
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.55);
    z-index: 9997;
  }
  .drawer-scrim.show { display: block; }

  .chart-wrap { height: 240px; }
  table { min-width: 960px; }
}
.drawer-scrim { display:none; } /* desktop default */

.inline-row { display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
.inline-row label { margin:0; }
.inline-row input[type="checkbox"] { width:auto; margin:0; }

.edit { cursor: pointer; user-select: none; opacity: 0.9; color: var(--yellow); }
.edit:hover { opacity: 1; }
.soldbtn { cursor: pointer; user-select: none; opacity: 0.95; color: var(--green); }
.soldbtn:hover { opacity: 1; }
.pill { display:inline-block; padding:3px 8px; border:1px solid var(--border); border-radius:999px; font-size:12px; color:var(--muted); }

.toast {
  position: fixed;
  left: 50%;
  bottom: 18px;
  transform: translateX(-50%);
  background: var(--panel);
  border: 1px solid var(--border);
  border-radius: 14px;
  padding: 12px 14px;
  z-index: 10010;
  display: none;
  max-width: 92vw;
  width: 520px;
}
.toast .row { display:flex; gap:10px; align-items:center; justify-content:space-between; flex-wrap:wrap; }
.toast .msg { font-size: 13px; color: var(--text); }
.toast .actions { display:flex; gap:10px; }

.modal {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.6);
  z-index: 10020;
  display: none;
  align-items: center;
  justify-content: center;
  padding: 16px;
}
.modal .box {
  width: 100%;
  max-width: 760px;
  background: var(--panel);
  border: 1px solid var(--border);
  border-radius: 18px;
  padding: 16px;
}
.modal .box h3 { margin:0 0 12px; font-size:13px; letter-spacing:1px; color: var(--accent); text-transform: uppercase; }
.modal .box .btnRow { display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end; }
.modal .box .btnRow button { width:auto; }




/* Hacker Cyan vibe: terminal depth + scanlines */
body{
  background:
    radial-gradient(900px 600px at 18% 12%, rgba(56,189,248,0.14), transparent 55%),
    radial-gradient(900px 600px at 78% 22%, rgba(34,211,238,0.10), transparent 55%),
    linear-gradient(180deg, #02040a 0%, #040814 50%, #02040a 100%);
}
body::before{
  content:"";
  position:fixed;
  inset:0;
  pointer-events:none;
  z-index:-1;
  background-image:
    repeating-linear-gradient(0deg, rgba(255,255,255,0.025) 0px, rgba(255,255,255,0.025) 1px, transparent 2px, transparent 6px),
    radial-gradient(1200px 800px at 50% 40%, rgba(56,189,248,0.06), transparent 60%);
  mix-blend-mode: overlay;
  opacity: 0.55;
}

/* Glassy panels */
.panel{
  background: var(--panel) !important;
  border: 1px solid var(--border) !important;
  backdrop-filter: blur(10px);
  -webkit-backdrop-filter: blur(10px);
  box-shadow: 0 18px 55px rgba(0,0,0,0.42);
}

/* Sidebar + topbar */
.sidebar{
  background: rgba(10,12,20,0.72) !important;
  border-right: 1px solid var(--border) !important;
  backdrop-filter: blur(12px);
  -webkit-backdrop-filter: blur(12px);
}
.topbar{
  background: rgba(8,10,16,0.70) !important;
  border-bottom: 1px solid var(--border) !important;
  backdrop-filter: blur(12px);
  -webkit-backdrop-filter: blur(12px);
}

/* Nav buttons */
.sidebar button{
  border-radius: 14px !important;
  border: 1px solid transparent !important;
  transition: transform .15s ease, background .15s ease, border-color .15s ease;
  position: relative;
}
.sidebar button:hover{
  transform: translateY(-1px);
  background: rgba(56,189,248,0.08) !important;
  border-color: rgba(56,189,248,0.18) !important;
}
.sidebar button.active{
  background: rgba(56,189,248,0.12) !important;
  border-color: rgba(56,189,248,0.25) !important;
  box-shadow: 0 10px 30px rgba(56,189,248,0.10);
}
.sidebar button.active::before{
  content:"";
  position:absolute;
  left:-2px;
  top:8px;
  bottom:8px;
  width:4px;
  border-radius: 999px;
  background: linear-gradient(180deg, rgba(56,189,248,0.95), rgba(34,211,238,0.85));
  box-shadow: 0 0 18px rgba(56,189,248,0.35);
}

/* Inputs/selects */
input, select, textarea{
  background: rgba(5,7,12,0.65) !important;
  border: 1px solid rgba(90,110,160,0.25) !important;
}
input:focus, select:focus, textarea:focus{
  outline: none;
  border-color: rgba(56,189,248,0.55) !important;
  box-shadow: 0 0 0 3px rgba(56,189,248,0.12);
}

/* Buttons */
button{
  background: rgba(56,189,248,0.12) !important;
  border: 1px solid rgba(56,189,248,0.28) !important;
}
button:hover{
  background: rgba(56,189,248,0.16) !important;
  border-color: rgba(56,189,248,0.40) !important;
}
button.danger{
  background: rgba(239,68,68,0.14) !important;
  border-color: rgba(239,68,68,0.35) !important;
}

/* Tables */
thead th{
  background: rgba(10,12,20,0.60) !important;
}
tbody tr:hover{
  background: rgba(56,189,248,0.06) !important;
}

/* Accent text */
.stat.blue{ color: var(--accent) !important; }
h3{ letter-spacing: 1.1px; }


/* ========= Theme Skins ========= */
/* shared base uses vars */
body{
  background: var(--bg);
}

/* Hacker Cyan skin */
html[data-theme="hackercyan"] body{
  background:
    radial-gradient(900px 600px at 18% 12%, rgba(56,189,248,0.14), transparent 55%),
    radial-gradient(900px 600px at 78% 22%, rgba(34,211,238,0.10), transparent 55%),
    linear-gradient(180deg, #02040a 0%, #040814 50%, #02040a 100%);
}
html[data-theme="hackercyan"] body::before{
  content:"";
  position:fixed;
  inset:0;
  pointer-events:none;
  z-index:-1;
  background-image:
    repeating-linear-gradient(0deg, rgba(255,255,255,0.025) 0px, rgba(255,255,255,0.025) 1px, transparent 2px, transparent 6px),
    radial-gradient(1200px 800px at 50% 40%, rgba(56,189,248,0.06), transparent 60%);
  mix-blend-mode: overlay;
  opacity: 0.55;
}

/* Cyber Red skin */
html[data-theme="cyberred"] body{
  background:
    radial-gradient(900px 600px at 18% 12%, rgba(255,77,77,0.14), transparent 55%),
    radial-gradient(900px 600px at 78% 22%, rgba(139,92,246,0.10), transparent 55%),
    linear-gradient(180deg, #030303 0%, #05060a 50%, #030303 100%);
}
html[data-theme="cyberred"] body::before{
  content:"";
  position:fixed;
  inset:0;
  pointer-events:none;
  z-index:-1;
  background-image:
    repeating-linear-gradient(0deg, rgba(255,255,255,0.03) 0px, rgba(255,255,255,0.03) 1px, transparent 2px, transparent 6px),
    radial-gradient(1200px 800px at 50% 40%, rgba(255,77,77,0.06), transparent 60%);
  mix-blend-mode: overlay;
  opacity: 0.55;
}

/* Make sure common UI pulls from vars */
.sidebar button:hover{
  background: color-mix(in srgb, var(--accent) 14%, transparent) !important;
  border-color: color-mix(in srgb, var(--accent) 22%, transparent) !important;
}
.sidebar button.active{
  background: color-mix(in srgb, var(--accent) 18%, transparent) !important;
  border-color: color-mix(in srgb, var(--accent) 30%, transparent) !important;
  box-shadow: 0 10px 30px color-mix(in srgb, var(--accent) 16%, transparent);
}
.sidebar button.active::before{
  background: linear-gradient(180deg, color-mix(in srgb, var(--accent) 95%, transparent), color-mix(in srgb, var(--accent-2) 85%, transparent));
  box-shadow: 0 0 18px color-mix(in srgb, var(--accent) 35%, transparent);
}

input:focus, select:focus, textarea:focus{
  border-color: color-mix(in srgb, var(--accent) 55%, transparent) !important;
  box-shadow: 0 0 0 3px color-mix(in srgb, var(--accent) 14%, transparent);
}

button{
  background: color-mix(in srgb, var(--accent) 14%, transparent) !important;
  border-color: color-mix(in srgb, var(--accent) 30%, transparent) !important;
}
button:hover{
  background: color-mix(in srgb, var(--accent) 18%, transparent) !important;
  border-color: color-mix(in srgb, var(--accent) 42%, transparent) !important;
}


/* Lock screen readability */
#lockScreen h3, #lockScreen .name { color: var(--text) !important; }
#lockScreen .muted, #lockScreen label { color: color-mix(in srgb, var(--text) 75%, var(--muted)) !important; }
#lockScreen .stat.muted { color: color-mix(in srgb, var(--text) 75%, var(--muted)) !important; }
#lockScreen .panel { box-shadow: 0 22px 70px rgba(0,0,0,0.55) !important; }


/* ========= Type Tags ========= */
#invType,#msType,#manualType,#soldTypeFilter{width:100%;}

/* Search bars above tables */
#activeSearchTop, #soldSearchTop{
  height: 38px;
}


/* Profit colors */
.profit-pos{ color: var(--green) !important; }
.profit-neg{ color: var(--red) !important; }
.profit-zero{ color: var(--muted) !important; }


/* RESELLr login logo (inside lock box) */
.lockBox .login-brand{
  display:flex;
  justify-content:center;
  align-items:center;
  margin: 2px 0 14px 0;
  padding: 0;
  background: transparent !important;
  border: none !important;
  box-shadow: none !important;
}
.lockBox .login-logo{
  width: 100%;
  max-width: 92%;
  max-height: 90px;
  height: auto;
  display:block;
  object-fit: contain;
  
  filter: none;
}



/* === RESELLr Login Logo (bigger override) === */
.lockBox .login-brand{
  width: 100%;
  display:flex;
  justify-content:center;
  align-items:center;
  margin: 4px 0 14px 0;
}

.lockBox .login-logo{
  width: 100% !important;
  max-width: 100% !important;
  height: auto !important;
  max-height: 140px !important; /* bigger */
  object-fit: contain !important;
  display:block !important;

  /* If the PNG has extra transparent padding, this scales it up visually */
  transform: scale(1.35);
  transform-origin: center;
}


/* === Net Worth (Dashboard) === */
#netWorthPanel .nw-total{
  font-size: 34px;
  font-weight: 800;
  letter-spacing: 0.5px;
  margin-top: 10px;
  margin-bottom: 2px;
}
#netWorthPanel .nw-grid{
  margin-top: 14px;
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(170px, 1fr));
  gap: 12px;
}
#netWorthPanel .nw-card{
  border: 1px solid var(--border);
  background: var(--panel-2);
  border-radius: 14px;
  padding: 12px 12px;
}
#netWorthPanel .nw-label{
  font-size: 12px;
  opacity: 0.75;
  letter-spacing: .12em;
  text-transform: uppercase;
}
#netWorthPanel .nw-value{
  margin-top: 6px;
  font-size: 18px;
  font-weight: 750;
}
#netWorthPanel.is-hidden #nwBody{ display:none; }
.nw-pos{ color: var(--green) !important; }
.nw-neg{ color: var(--red) !important; }


/* Smaller Net Worth toggles */
#netWorthPanel .pill{
  padding: 6px 10px !important;
  font-size: 12px !important;
  gap: 6px !important;
}
#netWorthPanel .pill input[type="checkbox"]{
  transform: scale(0.78);
  transform-origin: left center;
}
#netWorthPanel select{
  height: 30px;
  font-size: 12px;
  padding: 4px 8px;
}


/* ===== Net Worth toggle polish (safe CSS-only) ===== */
#netWorthPanel .networth-toggles{ gap:10px !important; }
#netWorthPanel .networth-toggles .pill{
  padding: 6px 10px !important;
  border-radius: 14px !important;
  border: 1px solid rgba(56,189,248,0.16) !important;
  background: rgba(2,6,23,0.18) !important;
  box-shadow: none !important;
}
#netWorthPanel .networth-toggles .pill span{
  font-size: 12px !important;
  opacity: .9;
}
#netWorthPanel .networth-toggles input[type="checkbox"]{
  transform: scale(.75);
  transform-origin: left center;
  margin-right: 6px !important;
}
#netWorthPanel .networth-toggles select{
  height: 32px !important;
  font-size: 12px !important;
  padding: 4px 10px !important;
  border-radius: 14px !important;
}


/* ===== Disable Buy Me a Coffee (safe) ===== */



/* soft auto-scroll on larger lists */
@media (prefers-reduced-motion: no-preference){
  }
    0%{ transform: translateY(0); }
    100%{ transform: translateY(-40%); }
  }
}


/* === Full-width Income Graph === */
#secDashboard .income-full{
  grid-column: 1 / -1;
}
#secDashboard .income-full .chart-wrap{
  height: 360px;
}
@media (max-width: 900px){
  #secDashboard .income-full{
    grid-column: auto;
  }
  #secDashboard .income-full .chart-wrap{
    height: 280px;
  }
}

</style>
</head>

<body>

<!-- LOGIN / LOCK SCREEN -->
<div id="lockScreen">
  <div class="lockBox">

    <div class="login-brand">
      <img src="resellr-logo.png" alt="RESELLr" class="login-logo">
    </div>

    <p class="lockTitle" id="lockTitle">Dashboard Lock</p>
    <p class="lockHint" id="lockHint"></p>

    <label>Passcode</label>
    <input id="passInput" type="password" autocomplete="current-password" placeholder="Enter passcode" />
    <button onclick="unlock()">Unlock</button>

    <div class="divider"></div>

    <div class="collapse-header" onclick="togglePassSettings()">
      <span>Passcode Settings</span>
      <span class="caret" id="passCaret">‚ñæ</span>
    </div>

    <div class="collapse-body" id="passSettingsBody">
      <div id="firstSetBlock">
        <p class="lockHint">No passcode set yet. Create one now (stored locally on this device).</p>
        <label>New passcode</label>
        <input id="firstNew1" type="password" placeholder="New passcode" />
        <label>Confirm new passcode</label>
        <input id="firstNew2" type="password" placeholder="Confirm passcode" />
        <button onclick="setPasscodeFirstTime()">Set Passcode</button>
      </div>

      <div id="changeBlock" style="display:none;">
        <p class="lockHint">To change your passcode, enter your current passcode first.</p>
        <label>Current passcode</label>
        <input id="oldPass" type="password" placeholder="Current passcode" />
        <label>New passcode</label>
        <input id="newPass1" type="password" placeholder="New passcode" />
        <label>Confirm new passcode</label>
        <input id="newPass2" type="password" placeholder="Confirm new passcode" />
        <button onclick="changePasscode()">Change Passcode</button>
      </div>

      <div class="divider"></div>

      <div class="collapse-header" onclick="toggleMasterReset()">
        <span>Reset With Master Phrase</span>
        <span class="caret" id="masterCaret">‚ñæ</span>
      </div>

      <div class="collapse-body" id="masterResetBody">
        <p class="lockHint">Forgot your passcode? Reset it with your master phrase (set once via console).</p>

        <label>Master Phrase</label>
        <input id="resetPhrase" type="password" placeholder="Master reset phrase" />

        <label>New Passcode</label>
        <input id="resetNew1" type="password" placeholder="New passcode" />

        <label>Confirm New Passcode</label>
        <input id="resetNew2" type="password" placeholder="Confirm new passcode" />

        <button class="danger" onclick="resetWithPhrase()">Reset Passcode</button>

        <div class="stat muted" style="margin-top:10px;">
          One-time setup (run in console): <span class="blue">setMasterPhraseOnce("your-phrase")</span>
        </div>
      </div>
    </div>

    <p class="lockMsg" id="lockMsg"></p>
  
</div>
</div>

<!-- UNDO TOAST -->
<div class="toast" id="undoToast">
  <div class="row">
    <div class="msg" id="undoMsg">Deleted.</div>
    <div class="actions">
      <button class="small" onclick="undoLastDelete()">Undo</button>
      <button class="small danger" onclick="hideUndo()">Close</button>
    </div>
  </div>
</div>

<!-- EDIT MODAL -->
<div class="modal" id="editModal" onclick="modalBackdropClose(event)">
  <div class="box" onclick="event.stopPropagation()">
    <h3 id="editTitle">Edit</h3>
    <div id="editBody"></div>
    <div class="divider"></div>
    <div class="btnRow">
      <button class="small" onclick="closeEditModal()">Cancel</button>
      <button class="small" onclick="saveEditModal()">Save</button>
    </div>
  </div>
</div>

<!-- MARK SOLD MODAL -->
<div class="modal" id="markSoldModal" onclick="modalBackdropClose(event)">
  <div class="box" onclick="event.stopPropagation()">
    <h3>Mark Item Sold</h3>

    <div class="grid" style="grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:12px;">
      <div>
        <label>Sold Date</label>
        <input type="date" id="msDate">
      </div>
      <div>
        <label>Sale ($)</label>
        <input type="number" id="msSale" step="0.01">
      </div>
      <div>
        <label>Type</label>
        <select id="msType">
          <option value="">‚Äî</option>
          <option value="Comic">Comic</option>
          <option value="Card">Card</option>
          <option value="Other">Other</option>
        </select>

        <label>Platform</label>
        <input type="text" id="msPlatform" placeholder="eBay, Mercari, etc.">
      </div>
      <div>
        <label>Fees ($)</label>
        <input type="number" id="msFees" step="0.01">
      </div>
      <div>
        <label>Shipping ($)</label>
        <input type="number" id="msShip" step="0.01">
      </div>
    </div>

    <label>Item</label>
    <input type="text" id="msItem">

    <div class="inline-row" style="margin-bottom:10px;">
      <input type="checkbox" id="msSyncIncome" checked>
      <label for="msSyncIncome" class="muted">Also update Income graph</label>
    </div>

    <div class="divider"></div>
    <div class="btnRow">
      <button class="small" onclick="closeMarkSoldModal()">Cancel</button>
      <button class="small" onclick="confirmMarkSold()">Move to Sold</button>
    </div>
  </div>
</div>

<!-- Topbar -->

<div class="topbar">
  <button class="hamburger" onclick="toggleSidebar()">‚ò∞</button>
  <div class="title" id="topbarTitle">RESELLr</div>
  <div style="display:flex; gap:10px; flex-wrap:wrap;">
    <button class="small" onclick="lockNow()">Lock</button>
    <button class="small danger" onclick="factoryReset()">Reset</button>
  </div>
</div>

<div class="app" id="appShell">

  <!-- Scrim for mobile -->
  <div class="drawer-scrim" id="drawerScrim" onclick="closeSidebar()"></div>

  <!-- Sidebar -->
  <aside class="sidebar" id="sidebar">
    <div class="brand">
      <div>
        <div class="name">RESELLr</div>
        <div class="muted" style="font-size:12px;margin-top:4px;">Inventory ‚Üí Sold ‚Üí Profit</div>
      </div>
      <button class="small" onclick="closeSidebar()">‚úï</button>
    </div>

    <div class="nav" id="nav">
      <button class="active" data-target="secDashboard" onclick="showSection('secDashboard')">üìä Dashboard</button>
      <button data-target="secInventory" onclick="showSection('secInventory')">üìã Inventory</button>
      <button data-target="secSold" onclick="showSection('secSold')">üì¶ Sold</button>
      <button data-target="secImportExport" onclick="showSection('secImportExport')">‚¨ÜÔ∏è‚¨áÔ∏è Import / Export</button>
      <button data-target="secTools" onclick="showSection('secTools')">üßÆ Tools</button>
      <button data-target="secSettings" onclick="showSection('secSettings')">‚öôÔ∏è Settings</button>
    </div>

    <div class="divider"></div>

    <button class="small" onclick="lockNow()">Lock</button>
    <button class="small danger" onclick="resetMonthlyIncome()">Reset Months</button>
    <button class="small danger" onclick="clearSold()">Clear Sold</button>

    <div class="stat muted" style="margin-top:auto;">
      Local-only ‚Ä¢ No cloud sync
    </div>
  </aside>

  <!-- Main -->
  <main class="canvas">

    <!-- DASHBOARD -->
    <section id="secDashboard" class="section active">
      <div class="grid">
        
        <div class="panel" id="netWorthPanel">
          <div class="row" style="display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap">
            <h3 style="margin:0">Net Worth</h3>
            <div class="row" style="display:flex;gap:10px;align-items:center;flex-wrap:wrap">
              <label class="pill" style="display:flex;gap:8px;align-items:center;margin:0">
                <input type="checkbox" id="nwShowToggle" />
                <span>Show</span>
              </label>
              <label class="pill" style="display:flex;gap:8px;align-items:center;margin:0">
                <input type="checkbox" id="nwConservativeToggle" />
                <span>Conservative</span>
              </label>
              <select id="nwRange" class="pill" style="margin:0">
                <option value="all">All‚Äëtime</option>
                <option value="ytd">YTD</option>
                <option value="30">Last 30 days</option>
              </select>
            </div>
          </div>

          <div id="nwBody">
            <div class="nw-total" id="nwTotal">$0.00</div>
            <div class="stat muted" id="nwSub">Net Worth = Inventory Value + Realized Profit</div>

            <div class="nw-grid">
              <div class="nw-card">
                <div class="nw-label">Inventory Value</div>
                <div class="nw-value" id="nwInvValue">$0.00</div>
              </div>
              <div class="nw-card">
                <div class="nw-label">Inventory Cost</div>
                <div class="nw-value" id="nwInvCost">$0.00</div>
              </div>
              <div class="nw-card">
                <div class="nw-label">Unrealized Gain</div>
                <div class="nw-value" id="nwUnrealized">$0.00</div>
              </div>
              <div class="nw-card">
                <div class="nw-label">Realized Profit</div>
                <div class="nw-value" id="nwRealized">$0.00</div>
              </div>
            </div>

            <div class="stat muted" style="margin-top:10px" id="nwAsOf"></div>
          </div>
        </div>

        <div class="panel">
        <div style="display:flex;justify-content:center;margin-bottom:14px;"><img src="./icons/icon-192.png" alt="RESELLr" style="width:54px;height:54px;border-radius:14px;border:1px solid var(--border);box-shadow:0 10px 25px rgba(0,0,0,0.35);"></div>

          <h3>Current Balance</h3>

          <label>Earnings ($)</label>
          <input type="number" id="earningsBalance" />

          <label>Inventory Allowance ($)</label>
          <input type="number" id="inventoryAllowance" />

          <button onclick="saveBalances()">Save</button>

          <div class="divider"></div>

          <div class="stat green" id="earningsStat"></div>
          <div class="stat blue" id="inventoryStat"></div>
        </div>

        <div class="panel" id="budgetPanel">
          <div style="display:flex;align-items:center;justify-content:space-between;gap:10px;margin-bottom:10px;">
            <h3 style="margin:0;">Next Month Inventory Budget</h3>
            <span class="pill muted" id="budgetMonthPill" style="height:30px;display:flex;align-items:center;">‚Äî</span>
          </div>

          <div class="grid2" style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:12px;">
            <div class="stat blue" id="mtdSalesStat">MTD SALES: $0</div>
            <div class="stat muted" id="mtdProfitStat">MTD PROFIT: $0</div>
            <div class="stat yellow" id="projSalesStat">PROJ SALES: $0</div>
            <div class="stat green" id="nextBudgetStat">NEXT BUDGET: $0</div>
          </div>

          <div style="display:flex;flex-wrap:wrap;gap:10px;align-items:center;margin-bottom:10px;">
            <div class="pill" style="display:flex;align-items:center;gap:10px;">
              <span class="muted" style="font-size:12px;">Reinvest %</span>
              <input id="reinvestPct" type="range" min="0" max="100" value="50" style="width:140px;">
              <span id="reinvestPctLabel" style="font-size:12px;">50%</span>
            </div>

            <div class="pill" style="display:flex;align-items:center;gap:10px;">
              <span class="muted" style="font-size:12px;">Mode</span>
              <select id="budgetMode" class="pill" style="height:32px;padding:4px 10px;">
                <option value="projected">Projected</option>
                <option value="mtd">If month ended today</option>
              </select>
            </div>
          </div>

          <div class="muted" style="font-size:12px;line-height:1.45;margin-bottom:8px;">
            Estimates what you can spend for <b>next month</b> using what you‚Äôve sold <b>so far this month</b>. It auto-rolls forward each month.
          </div>

          <div style="margin-top:10px;">
            <div class="muted" style="font-size:12px;margin-bottom:6px;">Month progress</div>
            <div class="progressBar"><div class="progressFill" id="monthProgressFill" style="width:0%"></div></div>
            <div class="muted" style="font-size:11px;margin-top:6px;" id="monthProgressLabel">‚Äî</div>
          </div>
        </div>

        <div class="panel income-full">
          <h3>Income Graph</h3>

          <label>Year Filter</label>
          <select id="yearFilter" onchange="loadIncomeChart()">
            <option value="ALL">ALL</option>
          </select>

          <div class="chart-wrap">
            <canvas id="incomeChart"></canvas>
          </div>

          <div class="divider"></div>

          <button onclick="rebuildMonthlyIncomeFromSold()">Sync Income From Sold</button>
          <div style="height:10px"></div>
          <button class="danger" onclick="resetMonthlyIncome()">Reset Month Data</button>
          <div class="stat muted" id="monthCountStat"></div>
        </div>
      </div>
    </section>

    <!-- INVENTORY -->
    <section id="secInventory" class="section">
      <div class="grid">
        <div class="panel">
          <h3>Inventory Filters</h3>

          <div class="grid" style="grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:12px;">
            <div>
              <label>Year</label>
              <select id="activeYearFilter" onchange="renderActive()">
                <option value="ALL">ALL</option>
              </select>
            </div>
            <div>
              <label>Month</label>
              <select id="activeMonthFilter" onchange="renderActive()">
                <option value="ALL">ALL</option>
              </select>
            </div>
</div>

          <div class="divider"></div>
          <div class="stat blue" id="activeCountStat"></div>
          <div class="stat green" id="activeCostStat"></div>
          <div class="stat blue" id="activeListStat"></div>
          <div class="stat muted" id="activeAvgCostStat"></div>
        </div>
      </div>

      <div class="grid" style="margin-top:16px;">
        <div class="panel">
          <h3>Add Inventory Item Manually</h3>

          <label>Acquired Date</label>
          <input type="date" id="invDate">

          <label>Item</label>
          <input type="text" id="invItem" placeholder="e.g. Batman #251">

          <div class="grid" style="grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:12px;">
            <div>
              <label>Type</label>
              <select id="invType">
                <option value="">‚Äî</option>
                <option value="Comic">Comic</option>
                <option value="Card">Card</option>
                <option value="Other">Other</option>
              </select>
              
              <label>Platform / Source</label>
              <input type="text" id="invPlatform" placeholder="garage sale, eBay, Mercari">
            </div>
            <div>
              <label>Cost ($)</label>
              <input type="number" id="invCost" step="0.01">
            </div>
            <div>
              <label>List ($)</label>
              <input type="number" id="invList" step="0.01">
            </div>
            <div>
              <label>Qty</label>
              <input type="number" id="invQty" value="1">
            </div>
          </div>

          <label>Notes</label>
          <input type="text" id="invNotes" placeholder="condition, grade, etc.">

          <button onclick="addActiveManually()">Add to Inventory</button>
        </div>
      </div>

      <div class="grid" style="margin-top:16px;">
        <div class="panel">
          <h3>Active Inventory Items</h3>
            <div class="inline-row" style="margin:10px 0 12px 0;">
              <input id="activeSearchTop" type="text" placeholder="Search active inventory‚Ä¶" oninput="setActiveSearch(this.value)" style="width:100%;">
            </div>

          <div class="table-wrap">
            <table>
              <thead>
                <tr>
                  <th>Date</th>
                  <th>Item</th>
                  <th>Type</th>
                  <th>Platform</th>
                  <th>Cost</th>
                  <th>List</th>
                  <th>Qty</th>
                  <th>Notes</th>
                  <th class="action-cell"></th>
                </tr>
              </thead>
              <tbody id="activeTableBody"></tbody>
            </table>
          </div>

          <div class="divider"></div>
          <div class="stat muted">Actions: <span class="pill">‚úèÔ∏è edit</span> <span class="pill">‚úÖ sold</span> <span class="pill">üóë delete</span></div>
        </div>
      </div>
    </section>


    <!-- SOLD -->
    <section id="secSold" class="section">
      <div class="grid">
        <div class="panel">
          <h3>Sold Summary</h3>


          <div class="grid" style="grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:12px;">
            <div>
              <label>Year</label>
              <select id="soldYearFilter" onchange="renderSold()">
                <option value="ALL">ALL</option>
              </select>
            </div>

            <div>
              <label>Month</label>
              <select id="soldMonthFilter" onchange="renderSold()">
                <option value="ALL">ALL</option>
              </select>
            </div>

            <div>
              <label>Type</label>
              <select id="soldTypeFilter" onchange="renderSold()">
                <option value="ALL">All</option>
                <option value="Comic">Comic</option>
                <option value="Card">Card</option>
                <option value="Other">Other</option>
              </select>
            </div>

            <div>
              <label>Platform</label>
              <select id="soldPlatformFilter" onchange="renderSold()">
                <option value="ALL">ALL</option>
              </select>
            </div>
          </div>

          <div class="divider"></div>

          <div class="stat blue" id="soldRevenueStat"></div>
          <div class="stat green" id="soldProfitStat"></div>
          <div class="stat yellow" id="soldItemsStat"></div>
          <div class="stat muted" id="soldAvgStat"></div>
        </div>
      </div>

      <div class="grid" style="margin-top:16px;">
        <div class="panel">
          <h3>Add Sold Item Manually</h3>

          <label>Date</label>
          <input type="date" id="manualDate">

          <label>Item</label>
          <input type="text" id="manualItem" placeholder="e.g. Amazing Spider-Man #300">

          <label>Type</label>
          <select id="manualType">
            <option value="">‚Äî</option>
            <option value="Comic">Comic</option>
            <option value="Card">Card</option>
            <option value="Other">Other</option>
          </select>

          <label>Platform</label>
          <input type="text" id="manualPlatform" placeholder="eBay, Mercari, etc.">

          <div class="grid" style="grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:12px;">
            <div>
              <label>Sale ($)</label>
              <input type="number" id="manualSale" />
            </div>
            <div>
              <label>Cost ($)</label>
              <input type="number" id="manualCost" />
            </div>
            <div>
              <label>Fees ($)</label>
              <input type="number" id="manualFees" />
            </div>
            <div>
              <label>Shipping ($)</label>
              <input type="number" id="manualShip" />
            </div>
          </div>

          <div class="inline-row" style="margin-bottom:10px;">
            <input type="checkbox" id="manualSyncIncome" checked>
            <label for="manualSyncIncome" class="muted">Also update Income graph</label>
          </div>

          <button onclick="addSoldManually()">Add Sold Item</button>
        </div>

        <div class="panel">
          <h3>Sold Graphs</h3>
          <div class="chart-wrap" style="height:280px;">
            <canvas id="soldProfitChart"></canvas>
          </div>
          <div class="divider"></div>
          <div class="chart-wrap" style="height:280px;">
            <canvas id="soldItemsChart"></canvas>
          </div>
          <div class="divider"></div>
          <div class="stat muted">Charts are monthly totals based on the sale date.</div>
        </div>
      </div>

      <div class="grid" style="margin-top:16px;">
        <div class="panel">
          <h3>Sold Items</h3>
            <div class="inline-row" style="margin:10px 0 12px 0;">
              <input id="soldSearchTop" type="text" placeholder="Search sold items‚Ä¶" oninput="setSoldSearch(this.value)" style="width:100%;">
            </div>

          <div class="table-wrap">
            <table>
              <thead>
                <tr>
                  <th>Date</th>
                  <th>Item</th>
                  <th>Type</th>
                  <th>Platform</th>
                  <th>Sale</th>
                  <th>Cost</th>
                  <th>Fees</th>
                  <th>Ship</th>
                  <th>Profit</th>
                  <th class="action-cell"></th>
                </tr>
              </thead>
              <tbody id="soldTableBody"></tbody>
            </table>
          </div>

          <div class="divider"></div>
          <button class="danger" onclick="removeLastSold()">Remove Last Imported Row</button>
          <div class="stat muted" id="soldRowCount"></div>
        </div>
      </div>
    </section>

    
    <!-- IMPORT / EXPORT -->
    <section id="secImportExport" class="section">
      <div class="grid">
        <div class="panel">
          <h3>Inventory Import / Export</h3>
          <div class="stat muted" style="line-height:1.5">
            Required columns: <span class="blue">date, item</span><br>
            Recommended: <span class="blue">type, platform, cost, list, qty, notes</span>
          </div>

          <div class="divider"></div>

          <label>CSV File</label>
          <input type="file" id="activeFile" accept=".csv,text/csv" />

          <button onclick="importActiveCSV()">Import Inventory CSV</button>

          <div class="divider"></div>

          <button onclick="exportActiveCSV()">Export Inventory (CSV)</button>
          <div style="height:10px"></div>
          <button class="danger" onclick="clearActive()">Clear Inventory</button>

          <div class="stat muted" id="activeImportMsg" style="margin-top:10px;"></div>
        </div>
        <div class="panel">
          <h3>Sold Import / Export</h3>

          <div class="stat muted" style="line-height:1.5">
            Required columns: <span class="blue">date, item, platform, sale</span><br>
            Optional: <span class="blue">type, cost, fees, shipping</span>
          </div>

          <div class="divider"></div>

          <label>CSV File</label>
          <input type="file" id="soldFile" accept=".csv,text/csv" />

          <div class="inline-row" style="margin-bottom:10px;">
            <input type="checkbox" id="syncIncomeToggle" checked>
            <label for="syncIncomeToggle" class="muted">Also update Income graph from sold data</label>
          </div>

          <button onclick="importSoldCSV()">Import CSV</button>

          <div class="divider"></div>

          <button onclick="exportSoldCSV()">Export Sold (CSV)</button>
          <div style="height:10px"></div>
          <button onclick="exportIncomeCSV()">Export Income (CSV)</button>
          <div class="stat muted" style="margin-top:10px;">Exports download as CSV you can open in Excel/Sheets.</div>

          <div class="divider"></div>

          <button class="danger" onclick="clearSold()">Clear Sold Data</button>
          <div class="stat muted" id="soldImportMsg"></div>
        </div>
      </div>

      <div class="grid" style="margin-top:16px;">
        <div class="panel">
          <h3>Tips</h3>
          <div class="stat muted" style="line-height:1.7">
            ‚Ä¢ Inventory import expects <span class="blue">date, item</span> and supports <span class="blue">type, platform, cost, list, qty, notes</span>.<br>
            ‚Ä¢ Sold import expects <span class="blue">date, item, platform, sale</span> and supports <span class="blue">type, cost, fees, shipping</span>.<br>
            ‚Ä¢ <span class="blue">Type</span> accepts: Comic / Card / Other.<br>
            ‚Ä¢ Exports download as CSV and can be opened in Excel or Google Sheets.
          </div>
        </div>
      </div>
    </section>


<!-- TOOLS -->
    <section id="secTools" class="section">
      <div class="grid">
        <div class="panel">
          <h3>Inventory Budget</h3>

          <label>Last Month Gross ($)</label>
          <input type="number" id="grossSales" />

          <button onclick="calculateBudget()">Calculate</button>

          <div class="divider"></div>

          <div class="stat blue" id="invStat"></div>
          <div class="stat green" id="profitStat"></div>
          <div class="stat yellow" id="holdStat"></div>
        </div>

        <div class="panel">
          <h3>Minimum Safe Sale Price</h3>

          <label>Item Cost ($)</label>
          <input type="number" id="itemCost" />

          <div class="grid" style="grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:12px;">
            <div>
              <label>Fees (%)</label>
              <input type="number" id="fees" value="15" />
            </div>
            <div>
              <label>Profit (%)</label>
              <input type="number" id="profit" value="30" />
            </div>
          </div>

          <button onclick="calculateMinPrice()">Calculate</button>

          <div class="divider"></div>
          <div class="stat blue" id="minPriceStat"></div>
        </div>
      </div>

      <div class="grid" style="margin-top:16px;">
        <div class="panel calc-half">
          <h3>Calculator</h3>

          <div class="calc-display" id="calcDisplay">0</div>

          <div class="calc-grid">
            <button class="calc-btn danger" onclick="calcClear()">C</button>
            <button class="calc-btn danger" onclick="calcBack()">‚å´</button>
            <button class="calc-btn op" onclick="calcPress('(')">(</button>
            <button class="calc-btn op" onclick="calcPress(')')">)</button>

            <button class="calc-btn" onclick="calcPress('7')">7</button>
            <button class="calc-btn" onclick="calcPress('8')">8</button>
            <button class="calc-btn" onclick="calcPress('9')">9</button>
            <button class="calc-btn op" onclick="calcPress('/')">√∑</button>

            <button class="calc-btn" onclick="calcPress('4')">4</button>
            <button class="calc-btn" onclick="calcPress('5')">5</button>
            <button class="calc-btn" onclick="calcPress('6')">6</button>
            <button class="calc-btn op" onclick="calcPress('*')">√ó</button>

            <button class="calc-btn" onclick="calcPress('1')">1</button>
            <button class="calc-btn" onclick="calcPress('2')">2</button>
            <button class="calc-btn" onclick="calcPress('3')">3</button>
            <button class="calc-btn op" onclick="calcPress('-')">‚àí</button>

            <button class="calc-btn" onclick="calcPress('0')">0</button>
            <button class="calc-btn" onclick="calcPress('.')">.</button>
            <button class="calc-btn eq" onclick="calcEquals()">=</button>
            <button class="calc-btn op" onclick="calcPress('+')">+</button>
          </div>

          <div class="divider"></div>
          <div class="stat muted">Supports + ‚àí √ó √∑ and parentheses.</div>
        </div>
      </div>
    </section>

    <!-- SETTINGS -->
    <section id="secSettings" class="section">
      <div class="grid">

        <div class="panel">
          <h3>Theme</h3>
          <div class="stat muted" style="margin-bottom:10px;">Switch the look of RESELLr.</div>

          <label>Theme</label>
          <select id="themeSelect" onchange="setTheme(this.value)">
            <option value="hackercyan">Hacker Cyan</option>
            <option value="cyberred">Cyber Red</option>
            <option value="monochrome">Black & White</option>
          </select>

          <div class="divider"></div>
          <div class="stat muted">Your choice is saved on this device.</div>
        </div>


        <div class="panel">
          <h3>Security & Data</h3>
          <div class="stat muted">
            ‚Ä¢ This dashboard is <span class="blue">local-only</span> (data saved in your browser).<br>
            ‚Ä¢ The passcode is a <span class="blue">client-side lock</span> (good for privacy on your device).<br>
            ‚Ä¢ If you forget your passcode, use your <span class="blue">master phrase</span> reset in the lock screen.
          </div>

          <div class="divider"></div>

          <button onclick="lockNow()">Lock Now</button>
          <div style="height:10px"></div>
          <button class="danger" onclick="factoryReset()">Factory Reset (All Data)</button>
          <div class="stat muted" style="margin-top:10px;">
            This clears: balances, monthly income, sold data, and passcode on this device.
          </div>
        </div>

        <div class="panel">
          <h3>PWA Status</h3>
          <div class="stat muted" id="pwaStat">Checking‚Ä¶</div>
          <div class="divider"></div>
          <div class="stat muted">
            Tip: On iPhone Safari ‚Üí Share ‚Üí <span class="blue">Add to Home Screen</span>.
          </div>
        </div>
      </div>
    </section>

  </main>
</div>

<script>

/* ========= PWA SERVICE WORKER ========= */
if ("serviceWorker" in navigator) {
  window.addEventListener("load", () => {
    navigator.serviceWorker.register("./service-worker.js").then(() => {
      const el = document.getElementById("pwaStat");
      if (el) el.textContent = "Service worker: registered ‚úÖ";
    }).catch(() => {
      const el = document.getElementById("pwaStat");
      if (el) el.textContent = "Service worker: not active (needs HTTPS/localhost).";
    });
  });
}

/* ========= NAV / SIDEBAR ========= */
function isMobile() { return window.matchMedia("(max-width: 900px)").matches; }

function setActiveNav(targetId) {
  const nav = document.getElementById("nav");
  if (!nav) return;
  [...nav.querySelectorAll("button[data-target]")].forEach(btn => {
    btn.classList.toggle("active", btn.getAttribute("data-target") === targetId);
  });
}

function showSection(sectionId) {
  document.querySelectorAll(".section").forEach(sec => {
    sec.classList.toggle("active", sec.id === sectionId);
  });

  setActiveNav(sectionId);

  const titleMap = { secDashboard:"Dashboard", secInventory:"Inventory", secSold:"Sold", secTools:"Tools", secSettings:"Settings", secImportExport:"Import / Export" };
  const t = document.getElementById("topbarTitle");
  if (t) t.textContent = titleMap[sectionId] || "RESELLr";

  if (isMobile()) closeSidebar();

  // Always start each tab at the top (prevents sections appearing "at the bottom")
  try { window.scrollTo({ top: 0, left: 0, behavior: 'instant' }); } catch (e) { window.scrollTo(0, 0); }
  document.documentElement.scrollTop = 0;
  document.body.scrollTop = 0;

  // Refresh budget panel when returning to Dashboard
  if (sectionId === 'secDashboard') { try { updateBudgetPanel(); } catch (e) {} }

  setTimeout(() => {
    if (incomeChartObj) incomeChartObj.resize();
    if (soldProfitChartObj) soldProfitChartObj.resize();
    if (soldItemsChartObj) soldItemsChartObj.resize();
  }, 80);
}

function toggleSidebar() {
  const app = document.getElementById("appShell");
  const sb = document.getElementById("sidebar");
  const scrim = document.getElementById("drawerScrim");
  if (!app || !sb || !scrim) return;

  if (isMobile()) {
    const open = sb.classList.toggle("open");
    scrim.classList.toggle("show", open);
  } else {
    app.classList.toggle("sidebar-closed");
  }
}

function closeSidebar() {
  const sb = document.getElementById("sidebar");
  const scrim = document.getElementById("drawerScrim");
  if (!sb || !scrim) return;
  sb.classList.remove("open");
  scrim.classList.remove("show");
}

window.addEventListener("keydown", (e) => {
  if (e.key === "Escape" && isMobile()) closeSidebar();
});

/* ========= COLLAPSE HELPERS ========= */
function togglePassSettings(forceOpen = null) {
  const body = document.getElementById("passSettingsBody");
  const caret = document.getElementById("passCaret");
  const isOpen = body.style.display === "block";
  const nextOpen = forceOpen === null ? !isOpen : !!forceOpen;
  body.style.display = nextOpen ? "block" : "none";
  caret.classList.toggle("open", nextOpen);
  if (!nextOpen) toggleMasterReset(false);
}
function toggleMasterReset(forceOpen = null) {
  const body = document.getElementById("masterResetBody");
  const caret = document.getElementById("masterCaret");
  if (!body || !caret) return;
  const isOpen = body.style.display === "block";
  const nextOpen = forceOpen === null ? !isOpen : !!forceOpen;
  body.style.display = nextOpen ? "block" : "none";
  caret.classList.toggle("open", nextOpen);
}

/* ========= LOCAL PASSCODE GATE ========= */
function simpleHash(str) {
  let h = 2166136261;
  for (let i = 0; i < str.length; i++) {
    h ^= str.charCodeAt(i);
    h = Math.imul(h, 16777619);
  }
  return (h >>> 0).toString(16);
}
function showLockScreen(show) { document.getElementById("lockScreen").style.display = show ? "flex" : "none"; }

function setMasterPhraseOnce(phrase) {
  if (localStorage.getItem("masterPhraseHash")) return false;
  localStorage.setItem("masterPhraseHash", simpleHash(String(phrase || "")));
  return true;
}

function resetWithPhrase() {
  const stored = localStorage.getItem("masterPhraseHash");
  const msg = document.getElementById("lockMsg");
  if (!stored) { msg.textContent = "No master phrase set on this device yet."; msg.style.color = "var(--red)"; return; }

  const phrase = document.getElementById("resetPhrase").value || "";
  const p1 = document.getElementById("resetNew1").value || "";
  const p2 = document.getElementById("resetNew2").value || "";

  if (simpleHash(phrase) !== stored) { msg.textContent = "Master phrase incorrect."; msg.style.color = "var(--red)"; return; }
  if (p1.length < 4) { msg.textContent = "New passcode must be at least 4 characters."; msg.style.color = "var(--red)"; return; }
  if (p1 !== p2) { msg.textContent = "New passcodes do not match."; msg.style.color = "var(--red)"; return; }

  localStorage.setItem("dashboardPassHash", simpleHash(p1));

  document.getElementById("resetPhrase").value = "";
  document.getElementById("resetNew1").value = "";
  document.getElementById("resetNew2").value = "";

  msg.textContent = "Passcode reset successfully. You can unlock now.";
  msg.style.color = "var(--green)";
}

function initLock() {
  const storedHash = localStorage.getItem("dashboardPassHash");
  const msg = document.getElementById("lockMsg");
  msg.textContent = "";
  msg.style.color = "var(--muted)";

  const firstSetBlock = document.getElementById("firstSetBlock");
  const changeBlock = document.getElementById("changeBlock");
  const hint = document.getElementById("lockHint");
  const title = document.getElementById("lockTitle");

  togglePassSettings(false);
  toggleMasterReset(false);

  if (!storedHash) {
    title.textContent = "Set a Passcode";
    hint.textContent = "Create a passcode once. After that, changing it requires your current passcode.";
    firstSetBlock.style.display = "block";
    changeBlock.style.display = "none";
    togglePassSettings(true);
    showLockScreen(true);
  } else {
    title.textContent = "Dashboard Locked";
    hint.textContent = "Enter your passcode to unlock. (Master phrase reset is in Passcode Settings.)";
    firstSetBlock.style.display = "none";
    changeBlock.style.display = "block";
    showLockScreen(true);
  }
}

function setPasscodeFirstTime() {
  const storedHash = localStorage.getItem("dashboardPassHash");
  const msg = document.getElementById("lockMsg");
  if (storedHash) { msg.textContent = "Passcode already set. Use Change Passcode."; msg.style.color = "var(--yellow)"; return; }

  const p1 = document.getElementById("firstNew1").value || "";
  const p2 = document.getElementById("firstNew2").value || "";
  if (p1.length < 4) { msg.textContent = "Passcode should be at least 4 characters."; msg.style.color = "var(--red)"; return; }
  if (p1 !== p2) { msg.textContent = "Passcodes do not match."; msg.style.color = "var(--red)"; return; }

  localStorage.setItem("dashboardPassHash", simpleHash(p1));
  document.getElementById("firstNew1").value = "";
  document.getElementById("firstNew2").value = "";

  msg.textContent = "Passcode set. Unlock using the passcode field above.";
  msg.style.color = "var(--green)";
}

function changePasscode() {
  const storedHash = localStorage.getItem("dashboardPassHash");
  const msg = document.getElementById("lockMsg");
  if (!storedHash) { msg.textContent = "No passcode set yet. Set one first."; msg.style.color = "var(--yellow)"; return; }

  const oldP = document.getElementById("oldPass").value || "";
  const p1 = document.getElementById("newPass1").value || "";
  const p2 = document.getElementById("newPass2").value || "";
  if (simpleHash(oldP) !== storedHash) { msg.textContent = "Current passcode is incorrect."; msg.style.color = "var(--red)"; return; }
  if (p1.length < 4) { msg.textContent = "New passcode should be at least 4 characters."; msg.style.color = "var(--red)"; return; }
  if (p1 !== p2) { msg.textContent = "New passcodes do not match."; msg.style.color = "var(--red)"; return; }

  localStorage.setItem("dashboardPassHash", simpleHash(p1));
  document.getElementById("oldPass").value = "";
  document.getElementById("newPass1").value = "";
  document.getElementById("newPass2").value = "";

  msg.textContent = "Passcode changed successfully.";
  msg.style.color = "var(--green)";
}

function unlock() {
  const storedHash = localStorage.getItem("dashboardPassHash");
  const input = document.getElementById("passInput").value || "";
  const msg = document.getElementById("lockMsg");
  if (!storedHash) { msg.textContent = "No passcode exists yet. Set one in Passcode Settings."; msg.style.color = "var(--yellow)"; return; }

  if (simpleHash(input) === storedHash) {
    document.getElementById("passInput").value = "";
    showLockScreen(false);
    togglePassSettings(false);
    toggleMasterReset(false);
  } else {
    msg.textContent = "Incorrect passcode.";
    msg.style.color = "var(--red)";
  }
}
function lockNow() { initLock(); }

window.addEventListener("keydown", (e) => {
  if (document.getElementById("lockScreen").style.display === "flex") {
    if (e.key === "Enter") unlock();
    if (e.key === "Escape") { toggleMasterReset(false); togglePassSettings(false); }
  }
});

/* ========= HELPERS ========= */
function formatDollars(v) {
  const n = Number(v);
  if (!isFinite(n)) return String(v);
  return "$" + n.toLocaleString(undefined, { maximumFractionDigits: 2 });
}
function extractYear(label) {
  const m = String(label).match(/(19|20)\d{2}/);
  return m ? m[0] : null;
}
function parseMoney(x) {
  if (x === null || x === undefined) return 0;
  const s = String(x).replace(/[$,]/g, "").trim();
  const n = parseFloat(s);
  return isFinite(n) ? n : 0;
}
function genId() {
  return "id_" + Date.now().toString(36) + "_" + Math.random().toString(36).slice(2, 8);
}

/* ========= DASHBOARD LOGIC ========= */
let incomeChartObj;

function saveBalances() {
  localStorage.setItem("earningsBalance", earningsBalance.value || 0);
  localStorage.setItem("inventoryAllowance", inventoryAllowance.value || 0);
  updateBalanceStats();
}
function updateBalanceStats() {
  const e = (+earningsBalance.value || 0);
  const i = (+inventoryAllowance.value || 0);
  earningsStat.textContent = `EARNINGS: ${formatDollars(e)}`;
  inventoryStat.textContent = `INVENTORY ALLOWANCE: ${formatDollars(i)}`;
}

function addMonthlyIncome() {
  const label = monthLabel.value.trim();
  const income = parseFloat(monthIncome.value);
  if (!label || isNaN(income)) return;

  const data = JSON.parse(localStorage.getItem("monthlyIncome")) || [];
  data.push({ label, income });
  localStorage.setItem("monthlyIncome", JSON.stringify(data));

  monthLabel.value = "";
  monthIncome.value = "";
  loadIncomeChart();
}
function resetMonthlyIncome() { localStorage.removeItem("monthlyIncome"); loadIncomeChart(); }

function refreshYearFilter(data) {
  const select = document.getElementById("yearFilter");
  if (!select) return;

  const current = select.value || "ALL";
  const years = Array.from(new Set(data.map(d => extractYear(d.label)).filter(Boolean))).sort();

  select.innerHTML = `<option value="ALL">ALL</option>` + years.map(y => `<option value="${y}">${y}</option>`).join("");
  const stillExists = [...select.options].some(o => o.value === current);
  select.value = stillExists ? current : "ALL";
}

const yearSeparatorPlugin = {
  id: "yearSeparatorPlugin",
  afterDraw(chart) {
    const yf = document.getElementById("yearFilter");
    if (yf && (yf.value === "ALL" || yf.value === "All" || yf.value === "all")) return;
    const { ctx, chartArea, scales } = chart;
    const x = scales.x;
    if (!x || !chartArea) return;

    const labels = chart.data.labels || [];
    if (labels.length < 2) return;

    ctx.save();
    ctx.font = '12px "JetBrains Mono","Fira Code",monospace';
    ctx.fillStyle = "#38bdf8";
    ctx.strokeStyle = "rgba(56,189,248,0.18)";
    ctx.lineWidth = 1;

    for (let i = 1; i < labels.length; i++) {
      const prevY = extractYear(labels[i - 1]);
      const curY = extractYear(labels[i]);
      if (curY && prevY && curY !== prevY) {
        const xPos = x.getPixelForTick(i);
        ctx.beginPath();
        ctx.moveTo(xPos, chartArea.top);
        ctx.lineTo(xPos, chartArea.bottom);
        ctx.stroke();
        ctx.fillText(curY, xPos + 6, chartArea.top + 14);
      }
    }
    ctx.restore();
  }
};

function loadIncomeChart() {
  const raw = JSON.parse(localStorage.getItem("monthlyIncome")) || [];
  monthCountStat.textContent = `MONTHS STORED: ${raw.length}`;
  refreshYearFilter(raw);

  const selectedYear = document.getElementById("yearFilter")?.value || "ALL";
  const data = selectedYear === "ALL" ? raw : raw.filter(d => extractYear(d.label) === selectedYear);

  if (incomeChartObj) incomeChartObj.destroy();

  incomeChartObj = new Chart(incomeChart, {
    type: "line",
    data: {
      labels: data.map(d => d.label),
      datasets: [{
        data: data.map(d => d.income),
        borderColor: "#38bdf8",
        borderWidth: 2,
        tension: 0.35,
        pointRadius: 3,
        pointHoverRadius: 5
      }]
    },
    plugins: [yearSeparatorPlugin],
    options: {
      maintainAspectRatio: false,
      plugins: {
        legend: { display: false },
        tooltip: { callbacks: { label: (ctx) => ` ${formatDollars(ctx.parsed.y)}` } }
      },
      scales: {
        x: { ticks: { color: "#6b7280" }, grid: { color: "rgba(31,41,55,0.55)" } },
        y: {
          beginAtZero: true,
          ticks: { color: "#6b7280", callback: (value) => formatDollars(value) },
          grid: { color: "rgba(31,41,55,0.55)" }
        }
      }
    }
  });
}

/* ========= SOLD DATA ========= */
const SOLD_KEY = "soldInventory";
let soldProfitChartObj, soldItemsChartObj;

function readSold() { return JSON.parse(localStorage.getItem(SOLD_KEY)) || []; }
function writeSold(arr) { localStorage.setItem(SOLD_KEY, JSON.stringify(arr)); }
try{ updateBudgetPanel(); }catch(e){}

/* Build monthlyIncome from sold rows (sale totals by month) */
function rebuildMonthlyIncomeFromSold() {
  const sold = readSold();
  const map = {};

  sold.forEach(row => {
    if (!row.date) return;
    const sale = Number(row.sale) || 0;
    const ym = String(row.date).slice(0, 7); // YYYY-MM
    if (!/^\d{4}-\d{2}$/.test(ym)) return;
    if (!map[ym]) map[ym] = 0;
    map[ym] += sale;
  });

  const monthNames = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];
  const monthly = Object.entries(map)
    .sort(([a],[b]) => a.localeCompare(b))
    .map(([ym, total]) => {
      const [y, m] = ym.split("-");
      const mi = Math.max(1, Math.min(12, parseInt(m, 10))) - 1;
      const label = `${monthNames[mi]} ${y}`;
      return { label, income: Number(total) || 0 };
    });

  localStorage.setItem("monthlyIncome", JSON.stringify(monthly));
  loadIncomeChart();
}
try{ updateBudgetPanel(); }catch(e){}


function parseCSV(text) {
  const rows = [];
  let i = 0, field = "", row = [], inQuotes = false;

  while (i < text.length) {
    const c = text[i];

    if (c === '"') {
      if (inQuotes && text[i + 1] === '"') { field += '"'; i += 2; continue; }
      inQuotes = !inQuotes; i++; continue;
    }

    if (!inQuotes && (c === ",")) { row.push(field); field = ""; i++; continue; }
    if (!inQuotes && (c === "\n" || c === "\r")) {
      if (c === "\r" && text[i + 1] === "\n") i++;
      row.push(field); field = "";
      if (row.some(x => String(x).trim().length)) rows.push(row);
      row = [];
      i++; continue;
    }
    field += c; i++;
  }

  row.push(field);
  if (row.some(x => String(x).trim().length)) rows.push(row);
  return rows;
}

function normalizeKey(s) {
  return String(s || "").trim().toLowerCase().replace(/\s+/g, "").replace(/[^a-z0-9]/g, "");
}

function normalizeType(v){
  const s = String(v||"").trim().toLowerCase();
  if (!s) return "";
  if (s.startsWith("comic") || s.includes("comic")) return "Comic";
  if (s.startsWith("card") || s.includes("card")) return "Card";
  if (s.startsWith("other") || s.includes("other")) return "Other";
  // allow shorthand
  if (s === "c") return "Comic";
  if (s === "k") return "Card";
  if (s === "o") return "Other";
  return "";
}


function parseDateAny(v) {
  const s = String(v || "").trim();
  if (!s) return null;

  const d = new Date(s);
  if (!isNaN(d.getTime())) return d;

  const m = s.match(/^(\d{1,2})\/(\d{1,2})\/(\d{2,4})$/);
  if (m) {
    const mm = parseInt(m[1], 10);
    const dd = parseInt(m[2], 10);
    let yy = parseInt(m[3], 10);
    if (yy < 100) yy += 2000;
    const d2 = new Date(yy, mm - 1, dd);
    if (!isNaN(d2.getTime())) return d2;
  }
  return null;
}

function formatDate(d) {
  if (!(d instanceof Date) || isNaN(d.getTime())) return "";
  const y = d.getFullYear();
  const m = String(d.getMonth() + 1).padStart(2, "0");
  const day = String(d.getDate()).padStart(2, "0");
  return `${y}-${m}-${day}`;
}

function importSoldCSV() {
  const f = document.getElementById("soldFile").files[0];
  const msg = document.getElementById("soldImportMsg");
  if (!f) { msg.textContent = "Choose a CSV first."; msg.style.color="var(--yellow)"; return; }

  const reader = new FileReader();
  reader.onload = () => {
    try {
      const text = String(reader.result || "");
      const parsed = parseCSV(text);
      if (!parsed.length) { msg.textContent = "CSV looks empty."; msg.style.color="var(--yellow)"; return; }

      const header = parsed[0].map(h => normalizeKey(h));
      const idx = (names) => {
        for (const n of names) {
          const k = normalizeKey(n);
          const i = header.indexOf(k);
          if (i !== -1) return i;
        }
        return -1;
      };

      const iDate = idx(["date","solddate","orderdate","transactiondate"]);
      const iItem = idx(["item","title","name","listing","description"]);
      const iType = idx(["type","category","kind","itemtype"]);
      const iPlatform = idx(["platform","market","marketplace","site"]);
      const iSale = idx(["sale","saleprice","sold","soldprice","price","gross","revenue"]);
      const iCost = idx(["cost","itemcost","cogs","purchase","buycost"]);
      const iFees = idx(["fees","fee","platformfees"]);
      const iShip = idx(["shipping","ship","shipcost","shippingcost"]);

      if (iDate === -1 || iItem === -1 || iPlatform === -1 || iSale === -1) {
        msg.textContent = "Missing required columns. Needs: date, item, platform, sale (names can vary).";
        msg.style.color = "var(--red)";
        return;
      }

      const existing = readSold();
      let added = 0;

      for (let r = 1; r < parsed.length; r++) {
        const row = parsed[r];
        const dateObj = parseDateAny(row[iDate]);
        if (!dateObj) continue;

        const item = String(row[iItem] || "").trim();
        const type = (iType !== -1) ? normalizeType(row[iType]) : "";
        const platform = String(row[iPlatform] || "").trim() || "Unknown";
        const sale = parseMoney(row[iSale]);
        const cost = iCost !== -1 ? parseMoney(row[iCost]) : 0;
        const fees = iFees !== -1 ? parseMoney(row[iFees]) : 0;
        const ship = iShip !== -1 ? parseMoney(row[iShip]) : 0;
        const profit = sale - cost - fees - ship;

        if (!item || !isFinite(sale)) continue;

        existing.push({
          _id: genId(),
          date: formatDate(dateObj),
          item, type, platform, sale, cost, fees, ship, profit
        });
        added++;
      }

      writeSold(existing);
      try{ updateBudgetPanel(); }catch(e){}
      msg.textContent = `Imported ${added} rows ‚úÖ`;
      msg.style.color = "var(--green)";

      renderSold();
      if (document.getElementById("syncIncomeToggle")?.checked) rebuildMonthlyIncomeFromSold();
    } catch {
      msg.textContent = "Import failed. Try exporting CSV again.";
      msg.style.color = "var(--red)";
    }
  };
  reader.readAsText(f);
}

function addSoldManually() {
  const d = manualDate.value;
  const item = (manualItem.value || "").trim();
  const type = (document.getElementById("manualType")?.value || "").trim();
  const platform = (manualPlatform.value || "").trim() || "Manual";
  const sale = Number(manualSale.value) || 0;
  const cost = Number(manualCost.value) || 0;
  const fees = Number(manualFees.value) || 0;
  const ship = Number(manualShip.value) || 0;

  if (!d || !item || !sale) return;

  const profit = sale - cost - fees - ship;
  const all = readSold();
  all.push({ _id: genId(), date: d, item, type, platform, sale, cost, fees, ship, profit });
  writeSold(all);

  renderSold();
  if (document.getElementById("manualSyncIncome")?.checked) rebuildMonthlyIncomeFromSold();

  manualDate.value = "";
  manualItem.value = "";
  const manualTypeEl = document.getElementById("manualType");
  if (manualTypeEl) manualTypeEl.value = "";
  manualPlatform.value = "";
  manualSale.value = "";
  manualCost.value = "";
  manualFees.value = "";
  manualShip.value = "";
}

function removeLastSold() {
  const data = readSold();
  data.pop();
  writeSold(data);
  renderSold();
  // keep income in sync if user wants it derived from sold
  rebuildMonthlyIncomeFromSold();
}

function deleteSoldById(id) {
  const arr = readSold();
  const idx = arr.findIndex(x => x && x._id === id);
  if (idx === -1) return;
  const removed = arr.splice(idx, 1)[0];
  writeSold(arr);
  renderSold();
  rebuildMonthlyIncomeFromSold();
  showUndo("Sold item deleted.", { key: SOLD_KEY, item: removed, index: idx });
}

function clearSold() {
  localStorage.removeItem(SOLD_KEY);
  renderSold();
  const msg = document.getElementById("soldImportMsg");
  if (msg) { msg.textContent = "Sold data cleared."; msg.style.color = "var(--yellow)"; }
  rebuildMonthlyIncomeFromSold();
}

function refreshSoldFilters(data) {
  const yearSel = document.getElementById("soldYearFilter");
  const platSel = document.getElementById("soldPlatformFilter");
  const monthSel = document.getElementById("soldMonthFilter");
  if (!yearSel || !platSel || !monthSel) return;

  const years = Array.from(new Set(data.map(x => extractYear(x.date)).filter(Boolean))).sort();
  const plats = Array.from(new Set(data.map(x => String(x.platform || "").trim()).filter(Boolean))).sort((a,b)=>a.localeCompare(b));
  const months = Array.from(new Set(data.map(x => monthKey(x.date)).filter(Boolean))).sort();

  const yCur = yearSel.value || "ALL";
  const pCur = platSel.value || "ALL";
  const mCur = monthSel.value || "ALL";

  yearSel.innerHTML = `<option value="ALL">ALL</option>` + years.map(y => `<option value="${y}">${y}</option>`).join("");
  platSel.innerHTML = `<option value="ALL">ALL</option>` + plats.map(p => `<option value="${p}">${p}</option>`).join("");

  const monthNames = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];
  monthSel.innerHTML = `<option value="ALL">ALL</option>` + months.map(ym => {
    const parts = ym.split("-");
    const y = parts[0];
    const mi = Math.max(1, Math.min(12, parseInt(parts[1], 10))) - 1;
    const label = `${monthNames[mi]} ${y}`;
    return `<option value="${ym}">${label}</option>`;
  }).join("");

  if ([...yearSel.options].some(o => o.value === yCur)) yearSel.value = yCur;
  if ([...platSel.options].some(o => o.value === pCur)) platSel.value = pCur;
  if ([...monthSel.options].some(o => o.value === mCur)) monthSel.value = mCur;
}

function monthKey(isoDate) {
  const s = String(isoDate || "");
  const m = s.match(/^(\d{4})-(\d{2})/);
  if (!m) return null;
  return `${m[1]}-${m[2]}`;
}

function renderSold() {
  const all = readSold();
  refreshSoldFilters(all);

  const year = document.getElementById("soldYearFilter")?.value || "ALL";
  const month = document.getElementById("soldMonthFilter")?.value || "ALL";
  const platform = document.getElementById("soldPlatformFilter")?.value || "ALL";
  const type = document.getElementById("soldTypeFilter")?.value || "ALL";

  const filtered = all.filter(r => {
    const yr = extractYear(r.date);
    const mk = monthKey(r.date);
    const okY = (year==="ALL") || (yr===year);
    const okM = (month==="ALL") || (mk===month);
    const okP = (platform==="ALL") || (String(r.platform||"")===platform);
    const okT = (type==="ALL") || (String(r.type||"")===type);
    const okS = (typeof matchesSoldSearch === "function") ? matchesSoldSearch(r) : true;
    return okY && okM && okP && okT && okS;
  });

  const tbody = document.getElementById("soldTableBody");
  if (!tbody) return;
  tbody.innerHTML = "";

  const sorted = [...filtered].sort((a,b)=> String(b.date||"").localeCompare(String(a.date||"")));

  for (const r of sorted){
    const tr = document.createElement("tr");

    const tdDate = document.createElement("td"); tdDate.textContent = r.date || ""; tr.appendChild(tdDate);
    const tdItem = document.createElement("td"); tdItem.textContent = r.item || ""; tr.appendChild(tdItem);
    const tdType = document.createElement("td"); tdType.textContent = r.type || ""; tr.appendChild(tdType);
    const tdPlat = document.createElement("td"); tdPlat.textContent = r.platform || ""; tr.appendChild(tdPlat);

    const tdSale = document.createElement("td"); tdSale.textContent = formatDollars(r.sale); tr.appendChild(tdSale);
    const tdCost = document.createElement("td"); tdCost.textContent = formatDollars(r.cost); tr.appendChild(tdCost);
    const tdFees = document.createElement("td"); tdFees.textContent = formatDollars(r.fees); tr.appendChild(tdFees);
    const tdShip = document.createElement("td"); tdShip.textContent = formatDollars(r.ship); tr.appendChild(tdShip);

    const tdProfit = document.createElement("td"); tdProfit.textContent = formatDollars(r.profit);
    const p = Number(r.profit)||0;
    if (p > 0) tdProfit.classList.add("profit-pos");
    else if (p < 0) tdProfit.classList.add("profit-neg");
    else tdProfit.classList.add("profit-zero");
    tr.appendChild(tdProfit);

    const action = document.createElement("td");
    action.className = "action-cell";
    const e = document.createElement("span");
    e.className = "edit";
    e.title = "Edit";
    e.textContent = "‚úèÔ∏è";
    e.onclick = () => openEditModal("sold", r._id);

    const del = document.createElement("span");
    del.className = "trash";
    del.title = "Delete";
    del.textContent = "üóë";
    del.style.marginLeft = "8px";
    del.onclick = () => deleteSoldById(r._id);

    action.appendChild(e); action.appendChild(del);
    tr.appendChild(action);

    tbody.appendChild(tr);
  }

  try{ updateSoldSummaryAndCharts(); }catch(e){}
  try{ updateNetWorth(); }catch(e){}

  safeBudgetRefresh();
}




/* ========= Tools ========= */
function calculateBudget() {
  const g = parseFloat(grossSales.value);
  if (isNaN(g)) return;
  invStat.textContent = `INVENTORY: ${formatDollars(g * 0.65)}`;
  profitStat.textContent = `PROFIT BUFFER: ${formatDollars(g * 0.20)}`;
  holdStat.textContent = `HOLDS: ${formatDollars(g * 0.15)}`;
}
function calculateMinPrice() {
  const cost = parseFloat(itemCost.value);
  const f = (parseFloat(fees.value) || 0) / 100;
  const p = (parseFloat(profit.value) || 0) / 100;

  if (isNaN(cost)) return;

  if (f + p >= 1) {
    minPriceStat.textContent = "ERROR: fees + profit must be under 100%";
    minPriceStat.className = "stat red";
    return;
  }

  const min = cost / (1 - f - p);
  minPriceStat.textContent = `MIN SAFE PRICE: ${formatDollars(min)}`;
  minPriceStat.className = "stat blue";
}

/* ========= CALCULATOR ========= */
let calcExpr = "";
function renderCalc() { calcDisplay.textContent = calcExpr.length ? calcExpr : "0"; }
function calcPress(ch) {
  const ok = "0123456789.+-*/()";
  if (!ok.includes(ch)) return;
  if (calcExpr === "ERR") calcExpr = "";
  calcExpr += ch;
  renderCalc();
}
function calcClear() { calcExpr = ""; renderCalc(); }
function calcBack() { calcExpr = calcExpr === "ERR" ? "" : calcExpr.slice(0, -1); renderCalc(); }
function calcEquals() {
  try {
    if (!calcExpr.trim() || calcExpr === "ERR") return;
    const val = Function(`"use strict"; return (${calcExpr});`)();
    calcExpr = String(Number(val.toFixed(10)));
    renderCalc();
  } catch { calcExpr = "ERR"; renderCalc(); }
}
renderCalc();

/* ========= Reset ========= */
function factoryReset() {
  const ok = confirm("Factory Reset: This will clear ALL local data on this device. Continue?");
  if (!ok) return;
  localStorage.clear();
  location.reload();
}



/* ========= Inventory (Active) ========= */
const ACTIVE_KEY = "activeInventory";

function readActive() { return JSON.parse(localStorage.getItem(ACTIVE_KEY)) || []; }
function writeActive(arr) { localStorage.setItem(ACTIVE_KEY, JSON.stringify(arr)); }

let lastDelete = null;
let undoTimer = null;

function showUndo(message, payload) {
  lastDelete = payload;
  const toast = document.getElementById("undoToast");
  const msg = document.getElementById("undoMsg");
  if (!toast || !msg) return;
  msg.textContent = message;
  toast.style.display = "block";

  if (undoTimer) clearTimeout(undoTimer);
  undoTimer = setTimeout(() => {
    hideUndo();
  }, 6000);
}
function hideUndo() {
  const toast = document.getElementById("undoToast");
  if (toast) toast.style.display = "none";
  lastDelete = null;
  if (undoTimer) { clearTimeout(undoTimer); undoTimer = null; }
}
function undoLastDelete() {
  if (!lastDelete) return;
  const { key, item, index } = lastDelete;
  const arr = JSON.parse(localStorage.getItem(key)) || [];
  const idx = Math.min(Math.max(0, index), arr.length);
  arr.splice(idx, 0, item);
  localStorage.setItem(key, JSON.stringify(arr));
  hideUndo();

  if (key === SOLD_KEY) { renderSold(); rebuildMonthlyIncomeFromSold(); }
  if (key === ACTIVE_KEY) { renderActive(); }
}

function modalBackdropClose(e) {
  // close only if click outside box
  if (e.target && e.target.classList.contains("modal")) {
    closeEditModal();
    closeMarkSoldModal();
  }
}

/* --- Active Inventory CSV --- */
function importActiveCSV() {
  const f = document.getElementById("activeFile").files[0];
  const msg = document.getElementById("activeImportMsg");
  if (!f) { msg.textContent = "Choose a CSV first."; msg.style.color="var(--yellow)"; return; }

  const reader = new FileReader();
  reader.onload = () => {
    try {
      const text = String(reader.result || "");
      const parsed = parseCSV(text);
      if (!parsed.length) { msg.textContent = "CSV looks empty."; msg.style.color="var(--yellow)"; return; }

      const header = parsed[0].map(h => normalizeKey(h));
      const idx = (names) => {
        for (const n of names) {
          const k = normalizeKey(n);
          const i = header.indexOf(k);
          if (i !== -1) return i;
        }
        return -1;
      };

      const iDate = idx(["date","acquireddate","purchasedate","boughtdate"]);
      const iItem = idx(["item","title","name","listing","description"]);
      const iType = idx(["type","category","kind","itemtype"]);
      const iPlatform = idx(["platform","source","market","marketplace","site"]);
      const iCost = idx(["cost","itemcost","cogs","purchase","buycost"]);
      const iList = idx(["list","listprice","ask","asking","price"]);
      const iQty = idx(["qty","quantity","count"]);
      const iNotes = idx(["notes","note","condition","details"]);

      if (iDate === -1 || iItem === -1) {
        msg.textContent = "Missing required columns. Needs at least: date, item.";
        msg.style.color = "var(--red)";
        return;
      }

      const existing = readActive();
      let added = 0;

      for (let r = 1; r < parsed.length; r++) {
        const row = parsed[r];
        const dateObj = parseDateAny(row[iDate]);
        if (!dateObj) continue;

        const item = String(row[iItem] || "").trim();
        const type = (iType !== -1) ? normalizeType(row[iType]) : "";
        if (!item) continue;

        const platform = iPlatform !== -1 ? String(row[iPlatform] || "").trim() : "";
        const cost = iCost !== -1 ? parseMoney(row[iCost]) : 0;
        const list = iList !== -1 ? parseMoney(row[iList]) : 0;
        const qty = iQty !== -1 ? (parseInt(String(row[iQty]||"1"), 10) || 1) : 1;
        const notes = iNotes !== -1 ? String(row[iNotes] || "").trim() : "";

        existing.push({
          _id: genId(),
          date: formatDate(dateObj),
          item,
          type,
          platform,
          cost,
          list,
          qty,
          notes
        });
        added++;
      }

      writeActive(existing);
      msg.textContent = `Imported ${added} rows ‚úÖ`;
      msg.style.color = "var(--green)";
      renderActive();
    } catch {
      msg.textContent = "Import failed. Try exporting CSV again.";
      msg.style.color = "var(--red)";
    }
  };
  reader.readAsText(f);
}

function exportActiveCSV() {
  const inv = readActive();
  const header = ["date","item","type","platform","cost","list","qty","notes"];
  const lines = [toCSVRow(header)];
  inv.slice().sort((a,b)=>String(a.date).localeCompare(String(b.date))).forEach(r => {
    lines.push(toCSVRow([
      r.date || "",
      r.item || "",
      r.type || "",
      r.platform || "",
      Number(r.cost || 0),
      Number(r.list || 0),
      Number(r.qty || 1),
      r.notes || ""
    ]));
  });
  downloadTextFile("inventory_export.csv", lines.join("\n"), "text/csv");
}

function clearActive() {
  const ok = confirm("Clear ALL active inventory items?");
  if (!ok) return;
  localStorage.removeItem(ACTIVE_KEY);
  renderActive();
  const msg = document.getElementById("activeImportMsg");
  if (msg) { msg.textContent = "Inventory cleared."; msg.style.color = "var(--yellow)"; }
}

function addActiveManually() {
  const d = invDate.value;
  const item = (invItem.value || "").trim();
  const type = (document.getElementById("invType")?.value || "").trim();
  const platform = (invPlatform.value || "").trim();
  const cost = Number(invCost.value) || 0;
  const list = Number(invList.value) || 0;
  const qty = parseInt(invQty.value || "1", 10) || 1;
  const notes = (invNotes.value || "").trim();

  if (!d || !item) return;

  const all = readActive();
  all.push({ _id: genId(), date: d, item, type, platform, cost, list, qty, notes });
  writeActive(all);
  renderActive();

  invDate.value = "";
  invItem.value = "";
  const invTypeEl = document.getElementById("invType");
  if (invTypeEl) invTypeEl.value = "";
  invPlatform.value = "";
  invCost.value = "";
  invList.value = "";
  invQty.value = "1";
  invNotes.value = "";
}

function refreshActiveFilters(data) {
  const yearSel = document.getElementById("activeYearFilter");
  const monthSel = document.getElementById("activeMonthFilter");
  const platSel = document.getElementById("activePlatformFilter");
  if (!yearSel || !monthSel || !platSel) return;

  const years = Array.from(new Set(data.map(x => extractYear(x.date)).filter(Boolean))).sort();
  const months = Array.from(new Set(data.map(x => monthKey(x.date)).filter(Boolean))).sort();
  const plats = Array.from(new Set(data.map(x => String(x.platform || "").trim()).filter(Boolean))).sort((a,b)=>a.localeCompare(b));

  const yCur = yearSel.value || "ALL";
  const mCur = monthSel.value || "ALL";
  const pCur = platSel.value || "ALL";

  yearSel.innerHTML = `<option value="ALL">ALL</option>` + years.map(y => `<option value="${y}">${y}</option>`).join("");

  const monthNames = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];
  monthSel.innerHTML = `<option value="ALL">ALL</option>` + months.map(ym => {
    const parts = ym.split("-");
    const y = parts[0];
    const mi = Math.max(1, Math.min(12, parseInt(parts[1], 10))) - 1;
    const label = `${monthNames[mi]} ${y}`;
    return `<option value="${ym}">${label}</option>`;
  }).join("");

  platSel.innerHTML = `<option value="ALL">ALL</option>` + plats.map(p => `<option value="${p}">${p}</option>`).join("");

  if ([...yearSel.options].some(o => o.value === yCur)) yearSel.value = yCur;
  if ([...monthSel.options].some(o => o.value === mCur)) monthSel.value = mCur;
  if ([...platSel.options].some(o => o.value === pCur)) platSel.value = pCur;
}

function renderActive() {
  const all = readActive();
  refreshActiveFilters(all);

  const year = document.getElementById("activeYearFilter")?.value || "ALL";
  const month = document.getElementById("activeMonthFilter")?.value || "ALL";
  const platformF = document.getElementById("activePlatformFilter")?.value || "ALL";

  const filtered = all.filter(r => {
    const yr = extractYear(r.date);
    const mk = monthKey(r.date);
    const okY = (year === "ALL") || (yr === year);
    const okM = (month === "ALL") || (mk === month);
    const okP = (platformF === "ALL") || (String(r.platform || "") === platformF);
    return okY && okM && okP && matchesActiveSearch(r);
  });

  // Stats
  const qty = filtered.reduce((s,x)=> s + (Number(x.qty)||1), 0);
  const totalCost = filtered.reduce((s,x)=> s + (Number(x.cost)||0) * (Number(x.qty)||1), 0);
  const totalList = filtered.reduce((s,x)=> s + (Number(x.list)||0) * (Number(x.qty)||1), 0);

  const countEl = document.getElementById("activeCountStat");
  const costEl = document.getElementById("activeCostStat");
  const listEl = document.getElementById("activeListStat");
  if (countEl) countEl.textContent = `ITEMS (QTY): ${qty}`;
  if (costEl) costEl.textContent = `TOTAL COST: ${formatDollars(totalCost)}`;
  if (listEl) listEl.textContent = `TOTAL LIST: ${formatDollars(totalList)}`;

  const tbody = document.getElementById("activeTableBody");
  if (!tbody) return;
  tbody.innerHTML = "";

  const sorted = [...filtered].sort((a,b)=> String(b.date||"").localeCompare(String(a.date||"")));

  for (const r of sorted){
    const tr = document.createElement("tr");

    const tdDate = document.createElement("td"); tdDate.textContent = r.date || ""; tr.appendChild(tdDate);
    const tdItem = document.createElement("td"); tdItem.textContent = r.item || ""; tr.appendChild(tdItem);
    const tdType = document.createElement("td"); tdType.textContent = r.type || ""; tr.appendChild(tdType);
    const tdPlat = document.createElement("td"); tdPlat.textContent = r.platform || ""; tr.appendChild(tdPlat);
    const tdCost = document.createElement("td"); tdCost.textContent = formatDollars(r.cost); tr.appendChild(tdCost);
    const tdList = document.createElement("td"); tdList.textContent = formatDollars(r.list); tr.appendChild(tdList);
    const tdQty = document.createElement("td"); tdQty.textContent = String(r.qty ?? 1); tr.appendChild(tdQty);
    const tdNotes = document.createElement("td"); tdNotes.textContent = r.notes || ""; tr.appendChild(tdNotes);

    const action = document.createElement("td");
    action.className = "action-cell";

    const e = document.createElement("span");
    e.className = "edit";
    e.title = "Edit";
    e.textContent = "‚úèÔ∏è";
    e.onclick = () => openEditModal("active", r._id);

    const sbtn = document.createElement("span");
    sbtn.className = "soldbtn";
    sbtn.title = "Mark Sold";
    sbtn.textContent = "‚úÖ";
    sbtn.style.marginLeft = "8px";
    sbtn.onclick = () => openMarkSoldModal(r._id);

    const d = document.createElement("span");
    d.className = "trash";
    d.title = "Delete";
    d.textContent = "üóë";
    d.style.marginLeft = "8px";
    d.onclick = () => deleteActiveById(r._id);

    action.appendChild(e); action.appendChild(sbtn); action.appendChild(d);
    tr.appendChild(action);

    tbody.appendChild(tr);
  }
  try{ updateNetWorth(); }catch(e){}

  safeBudgetRefresh();
}


function deleteActiveById(id) {
  const arr = readActive();
  const idx = arr.findIndex(x => x && x._id === id);
  if (idx === -1) return;
  const removed = arr.splice(idx, 1)[0];
  writeActive(arr);
  renderActive();
  showUndo("Inventory item deleted.", { key: ACTIVE_KEY, item: removed, index: idx });
}

/* ========= Edit Modal (Sold + Active) ========= */
let editContext = null; // { type: 'sold'|'active', id: '...', key: ... }

function openEditModal(type, id) {
  const modal = document.getElementById("editModal");
  const body = document.getElementById("editBody");
  const title = document.getElementById("editTitle");
  if (!modal || !body || !title) return;

  editContext = { type, id };
  let obj = null;

  if (type === "sold") obj = readSold().find(x => x && x._id === id);
  if (type === "active") obj = readActive().find(x => x && x._id === id);
  if (!obj) return;

  const safe = (v) => String(v || "").replace(/"/g, "&quot;");

  const typeSelect = `
      <label>Type</label>
      <select id="eType">
        <option value="" ${!obj.type ? "selected" : ""}>‚Äî</option>
        <option value="Comic" ${obj.type==="Comic" ? "selected" : ""}>Comic</option>
        <option value="Card" ${obj.type==="Card" ? "selected" : ""}>Card</option>
        <option value="Other" ${obj.type==="Other" ? "selected" : ""}>Other</option>
      </select>
  `;

  if (type === "sold") {
    title.textContent = "Edit Sold Item";
    body.innerHTML = `
      <label>Date</label><input type="date" id="eDate" value="${obj.date || ""}">
      <label>Item</label><input type="text" id="eItem" value="${safe(obj.item)}">
      ${typeSelect}
      <label>Platform</label><input type="text" id="ePlatform" value="${safe(obj.platform)}">
      <div class="grid" style="grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:12px;">
        <div><label>Sale ($)</label><input type="number" id="eSale" step="0.01" value="${obj.sale ?? 0}"></div>
        <div><label>Cost ($)</label><input type="number" id="eCost" step="0.01" value="${obj.cost ?? 0}"></div>
        <div><label>Fees ($)</label><input type="number" id="eFees" step="0.01" value="${obj.fees ?? 0}"></div>
        <div><label>Shipping ($)</label><input type="number" id="eShip" step="0.01" value="${obj.ship ?? 0}"></div>
      </div>
      <div class="stat muted">Profit auto-recalculates on save.</div>
    `;
  } else {
    title.textContent = "Edit Inventory Item";
    body.innerHTML = `
      <label>Acquired Date</label><input type="date" id="eDate" value="${obj.date || ""}">
      <label>Item</label><input type="text" id="eItem" value="${safe(obj.item)}">
      ${typeSelect}
      <label>Platform / Source</label><input type="text" id="ePlatform" value="${safe(obj.platform)}">
      <div class="grid" style="grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:12px;">
        <div><label>Cost ($)</label><input type="number" id="eCost" step="0.01" value="${obj.cost ?? 0}"></div>
        <div><label>List ($)</label><input type="number" id="eList" step="0.01" value="${obj.list ?? 0}"></div>
        <div><label>Qty</label><input type="number" id="eQty" value="${obj.qty ?? 1}"></div>
      </div>
      <label>Notes</label><input type="text" id="eNotes" value="${safe(obj.notes)}">
    `;
  }

  modal.style.display = "flex";
}

function closeEditModal() {
  const modal = document.getElementById("editModal");
  if (modal) modal.style.display = "none";
  editContext = null;
}

function saveEditModal() {
  if (!editContext) return;

  const d = document.getElementById("eDate")?.value || "";
  const item = (document.getElementById("eItem")?.value || "").trim();
  const platform = (document.getElementById("ePlatform")?.value || "").trim();
  const t = (document.getElementById("eType")?.value || "").trim();

  if (!d || !item) return;

  if (editContext.type === "sold") {
    const sale = Number(document.getElementById("eSale")?.value) || 0;
    const cost = Number(document.getElementById("eCost")?.value) || 0;
    const fees = Number(document.getElementById("eFees")?.value) || 0;
    const ship = Number(document.getElementById("eShip")?.value) || 0;
    const profit = sale - cost - fees - ship;

    const arr = readSold();
    const idx = arr.findIndex(x => x && x._id === editContext.id);
    if (idx === -1) return;
    arr[idx] = { ...arr[idx], date:d, item, type:t, platform, sale, cost, fees, ship, profit };
    writeSold(arr);
    renderSold();
    rebuildMonthlyIncomeFromSold();
  } else {
    const cost = Number(document.getElementById("eCost")?.value) || 0;
    const list = Number(document.getElementById("eList")?.value) || 0;
    const qty = parseInt(document.getElementById("eQty")?.value || "1", 10) || 1;
    const notes = (document.getElementById("eNotes")?.value || "").trim();

    const arr = readActive();
    const idx = arr.findIndex(x => x && x._id === editContext.id);
    if (idx === -1) return;
    arr[idx] = { ...arr[idx], date:d, item, type:t, platform, cost, list, qty, notes };
    writeActive(arr);
    renderActive();
  }

  closeEditModal();
}

/* ========= Mark Sold (move Inventory -> Sold) ========= */
let markSoldActiveId = null;

function openMarkSoldModal(activeId) {
  const inv = readActive().find(x => x && x._id === activeId);
  if (!inv) return;
  markSoldActiveId = activeId;

  const modal = document.getElementById("markSoldModal");
  if (!modal) return;

  const today = new Date();
  const y = today.getFullYear();
  const m = String(today.getMonth()+1).padStart(2,"0");
  const d = String(today.getDate()).padStart(2,"0");
  document.getElementById("msDate").value = `${y}-${m}-${d}`;
  document.getElementById("msSale").value = inv.list || "";
  document.getElementById("msPlatform").value = inv.platform || "";
  document.getElementById("msFees").value = "";
  document.getElementById("msShip").value = "";
  document.getElementById("msItem").value = inv.item || "";
  const msTypeEl = document.getElementById("msType");
  if (msTypeEl) msTypeEl.value = inv.type || "";
  document.getElementById("msSyncIncome").checked = true;

  modal.style.display = "flex";
}

function closeMarkSoldModal() {
  const modal = document.getElementById("markSoldModal");
  if (modal) modal.style.display = "none";
  markSoldActiveId = null;
}

function confirmMarkSold() {
  if (!markSoldActiveId) return;

  const soldDate = document.getElementById("msDate").value;
  const item = (document.getElementById("msItem").value || "").trim();
  const type = (document.getElementById("msType")?.value || "").trim();
  const platform = (document.getElementById("msPlatform").value || "").trim() || "Unknown";
  const sale = Number(document.getElementById("msSale").value) || 0;
  const fees = Number(document.getElementById("msFees").value) || 0;
  const ship = Number(document.getElementById("msShip").value) || 0;

  if (!soldDate || !item || !sale) return;

  const invArr = readActive();
  const invIdx = invArr.findIndex(x => x && x._id === markSoldActiveId);
  if (invIdx === -1) return;
  const inv = invArr[invIdx];

  const cost = Number(inv.cost) || 0;
  const profit = sale - cost - fees - ship;

  // Add to sold
  const soldArr = readSold();
  soldArr.push({ _id: genId(), date: soldDate, item, type, platform, sale, cost, fees, ship, profit });
  writeSold(soldArr);

  // Remove from active
  const removed = invArr.splice(invIdx, 1)[0];
  writeActive(invArr);

  renderActive();
  renderSold();

  if (document.getElementById("msSyncIncome")?.checked) rebuildMonthlyIncomeFromSold();

  closeMarkSoldModal();
}

/* ========= Export ========= */
function downloadTextFile(filename, text, mime="text/plain") {
  const blob = new Blob([text], { type: mime });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
}
function toCSVRow(values) {
  return values.map(v => {
    const s = (v === null || v === undefined) ? "" : String(v);
    if (/[",\n\r]/.test(s)) return `"${s.replace(/"/g, '""')}"`;
    return s;
  }).join(",");
}
function exportSoldCSV() {
  const sold = readSold();
  const header = ["date","item","type","platform","sale","cost","fees","shipping","profit"];
  const lines = [toCSVRow(header)];
  sold.slice().sort((a,b)=>String(a.date).localeCompare(String(b.date))).forEach(r => {
    lines.push(toCSVRow([
      r.date || "",
      r.item || "",
      r.type || "",
      r.platform || "",
      Number(r.sale || 0),
      Number(r.cost || 0),
      Number(r.fees || 0),
      Number(r.ship || 0),
      Number(r.profit || 0)
    ]));
  });
  downloadTextFile("sold_export.csv", lines.join("\n"), "text/csv");
}
function exportIncomeCSV() {
  const income = JSON.parse(localStorage.getItem("monthlyIncome")) || [];
  const header = ["month","income"];
  const lines = [toCSVRow(header)];
  income.forEach(r => lines.push(toCSVRow([r.label || "", Number(r.income || 0)])));
  downloadTextFile("income_export.csv", lines.join("\n"), "text/csv");
}


/* ========= Theme ========= */
const THEME_KEY = "ots_theme";

function applyTheme(theme) {
  let t = "hackercyan";
  if (theme === "cyberred") t = "cyberred";
  if (theme === "monochrome") t = "monochrome";

  document.documentElement.setAttribute("data-theme", t);
  localStorage.setItem(THEME_KEY, t);

  const sel = document.getElementById("themeSelect");
  if (sel) sel.value = t;
}

function setTheme(theme) {
  applyTheme(theme);
}


/* ========= Support Button Behavior ========= */
let _lastScrollY = 0;
let _scrollTick = false;




/* Keep support button in sync with lock screen */
document.addEventListener("DOMContentLoaded", () => {
  initNetWorthUI();

  const lock = document.getElementById("lockScreen");
  if (!lock) return;
});


/* ========= Active Inventory Search ========= */
let activeSearch = "";
function setActiveSearch(val){
  activeSearch = (val || "").trim().toLowerCase();
  renderActive();
}
function matchesActiveSearch(obj){
  if (!activeSearch) return true;
  const hay = [obj.item, obj.notes, obj.platform, obj.type].join(" ").toLowerCase();
  return hay.includes(activeSearch);
}


/* ========= Search Helpers ========= */
let activeSearchTerm = "";
let soldSearchTerm = "";

function setActiveSearch(val){
  activeSearchTerm = (val || "").trim().toLowerCase();
  renderActive();
}
function matchesActiveSearch(obj){
  if (!activeSearchTerm) return true;
  const hay = [obj.item, obj.notes, obj.platform, obj.type].join(" ").toLowerCase();
  return hay.includes(activeSearchTerm);
}

function setSoldSearch(val){
  soldSearchTerm = (val || "").trim().toLowerCase();
  renderSold();
}
function matchesSoldSearch(obj){
  if (!soldSearchTerm) return true;
  const hay = [obj.item, obj.platform, obj.type].join(" ").toLowerCase();
  return hay.includes(soldSearchTerm);
}




/* ========= Sold Summary + Charts (safe) ========= */
window.otsUpdateSoldSummaryAndCharts = function(){
  try{
    const all = (typeof readSold === "function") ? readSold() : [];
    const year = document.getElementById("soldYearFilter")?.value || "ALL";
    const month = document.getElementById("soldMonthFilter")?.value || "ALL";
    const platform = document.getElementById("soldPlatformFilter")?.value || "ALL";
    const type = document.getElementById("soldTypeFilter")?.value || "ALL";

    const filtered = all.filter(r => {
      const yr = (typeof extractYear==="function") ? extractYear(r.date) : "";
      const mk = (typeof monthKey==="function") ? monthKey(r.date) : "";
      const okY = (year==="ALL") || (yr===year);
      const okM = (month==="ALL") || (mk===month);
      const okP = (platform==="ALL") || (String(r.platform||"")===platform);
      const okT = (type==="ALL") || (String(r.type||"")===type);
      const okS = (typeof matchesSoldSearch==="function") ? matchesSoldSearch(r) : true;
      return okY && okM && okP && okT && okS;
    });

    const revenue = filtered.reduce((s,x)=>s + (Number(x.sale)||0), 0);
    const profit  = filtered.reduce((s,x)=>s + (Number(x.profit)||0), 0);
    const items   = filtered.length;
    const avg     = items ? profit/items : 0;

    const revEl = document.getElementById("soldRevenueStat");
    const proEl = document.getElementById("soldProfitStat");
    const itEl  = document.getElementById("soldItemsStat");
    const avgEl = document.getElementById("soldAvgStat");

    if (revEl) revEl.textContent = `REVENUE: ${formatDollars(revenue)}`;
    if (proEl){
      proEl.textContent = `PROFIT: ${formatDollars(profit)}`;
      proEl.classList.remove("profit-pos","profit-neg","profit-zero");
      if (profit > 0) proEl.classList.add("profit-pos");
      else if (profit < 0) proEl.classList.add("profit-neg");
      else proEl.classList.add("profit-zero");
    }
    if (itEl) itEl.textContent = `ITEMS SOLD: ${items}`;
    if (avgEl) avgEl.textContent = `AVG PROFIT/ITEM: ${formatDollars(avg)}`;

    // Charts (monthly)
    const buckets = {};
    for (const r of filtered){
      const k = (typeof monthKey==="function") ? monthKey(r.date) : "";
      if (!k) continue;
      if (!buckets[k]) buckets[k] = {profit:0, items:0};
      buckets[k].profit += Number(r.profit)||0;
      buckets[k].items += 1;
    }
    const labels = Object.keys(buckets).sort();
    const profitSeries = labels.map(k => +buckets[k].profit.toFixed(2));
    const itemsSeries  = labels.map(k => buckets[k].items);

    if (typeof Chart !== "undefined"){
      const c1 = document.getElementById("soldProfitChart");
      const c2 = document.getElementById("soldItemsChart");

      if (c1){
        if (window._otsSoldProfitChart) window._otsSoldProfitChart.destroy();
        window._otsSoldProfitChart = new Chart(c1, {
          type: "bar",
          data: { labels, datasets: [{ label: "Profit", data: profitSeries }] },
          options: { responsive:true, maintainAspectRatio:false, plugins:{legend:{display:false}}, scales:{y:{beginAtZero:true}} }
        });
      }
      if (c2){
        if (window._otsSoldItemsChart) window._otsSoldItemsChart.destroy();
        window._otsSoldItemsChart = new Chart(c2, {
          type: "bar",
          data: { labels, datasets: [{ label: "Items Sold", data: itemsSeries }] },
          options: { responsive:true, maintainAspectRatio:false, plugins:{legend:{display:false}}, scales:{y:{beginAtZero:true, ticks:{precision:0}}} }
        });
      }
    }
  }catch(e){}
};


/* ========= Sold Summary + Charts ========= */
let otsSoldProfitChart = null;
let otsSoldItemsChart = null;

function getFilteredSoldForSummary(){
  const all = readSold();
  const year = document.getElementById("soldYearFilter")?.value || "ALL";
  const month = document.getElementById("soldMonthFilter")?.value || "ALL";
  const platform = document.getElementById("soldPlatformFilter")?.value || "ALL";
  const type = document.getElementById("soldTypeFilter")?.value || "ALL";
  return all.filter(r => {
    const yr = extractYear(r.date);
    const mk = monthKey(r.date);
    const okY = (year==="ALL") || (yr===year);
    const okM = (month==="ALL") || (mk===month);
    const okP = (platform==="ALL") || (String(r.platform||"")===platform);
    const okT = (type==="ALL") || (String(r.type||"")===type);
    return okY && okM && okP && okT && (typeof matchesSoldSearch==="function" ? matchesSoldSearch(r) : true);
  });
}

function updateSoldSummaryAndCharts(){
  const data = getFilteredSoldForSummary();

  const revenue = data.reduce((s,x)=> s + (Number(x.sale)||0), 0);
  const profit  = data.reduce((s,x)=> s + (Number(x.profit)||0), 0);
  const items   = data.length;
  const avg     = items ? profit/items : 0;

  const revEl = document.getElementById("soldRevenueStat");
  const proEl = document.getElementById("soldProfitStat");
  const itEl  = document.getElementById("soldItemsStat");
  const avgEl = document.getElementById("soldAvgStat");

  if (revEl) revEl.textContent = `REVENUE: ${formatDollars(revenue)}`;
  if (proEl){
    proEl.textContent = `PROFIT: ${formatDollars(profit)}`;
    proEl.classList.remove("profit-pos","profit-neg","profit-zero");
    if (profit > 0) proEl.classList.add("profit-pos");
    else if (profit < 0) proEl.classList.add("profit-neg");
    else proEl.classList.add("profit-zero");
  }
  if (itEl) itEl.textContent = `ITEMS SOLD: ${items}`;
  if (avgEl) avgEl.textContent = `AVG PROFIT/ITEM: ${formatDollars(avg)}`;

  // Monthly buckets
  const buckets = {};
  for (const r of data){
    const mk = monthKey(r.date);
    if (!mk) continue;
    if (!buckets[mk]) buckets[mk] = {profit:0, items:0};
    buckets[mk].profit += Number(r.profit)||0;
    buckets[mk].items += 1;
  }
  const labels = Object.keys(buckets).sort();
  const profitSeries = labels.map(k => +buckets[k].profit.toFixed(2));
  const itemsSeries = labels.map(k => buckets[k].items);

  const canvasP = document.getElementById("soldProfitChart");
  const canvasI = document.getElementById("soldItemsChart");
  if (typeof Chart === "undefined") return;

  if (canvasP){
    if (otsSoldProfitChart) otsSoldProfitChart.destroy();
    otsSoldProfitChart = new Chart(canvasP, {
      type: "bar",
      data: { labels, datasets: [{ label: "Profit", data: profitSeries }] },
      options: { responsive:true, maintainAspectRatio:false, plugins:{legend:{display:false}}, scales:{ y:{ beginAtZero:true } } }
    });
  }
  if (canvasI){
    if (otsSoldItemsChart) otsSoldItemsChart.destroy();
    otsSoldItemsChart = new Chart(canvasI, {
      type: "bar",
      data: { labels, datasets: [{ label: "Items Sold", data: itemsSeries }] },
      options: { responsive:true, maintainAspectRatio:false, plugins:{legend:{display:false}}, scales:{ y:{ beginAtZero:true, ticks:{ precision:0 } } } }
    });
  }
}
// alias for older calls
window.otsUpdateSoldSummaryAndCharts = updateSoldSummaryAndCharts;


/* ========= NET WORTH ========= */
const NW_SHOW_KEY = "resellr_nw_show";
const NW_CONS_KEY = "resellr_nw_conservative";

function startOfToday() {
  const d = new Date();
  d.setHours(0,0,0,0);
  return d;
}
function parseDateSafe(s){
  if (!s) return null;
  // Accept YYYY-MM-DD
  const d = new Date(s + "T00:00:00");
  return isNaN(d.getTime()) ? null : d;
}
function sumActiveValue(conservative=false){
  const active = readActive();
  let invCost = 0;
  let invValue = 0;
  active.forEach(r=>{
    const qty = Number(r.qty ?? 1) || 1;
    const cost = Number(r.cost)||0;
    const list = Number(r.list)||0;
    invCost += cost * qty;
    invValue += (conservative ? cost : list) * qty;
  });
  return { invCost, invValue };
}
function sumRealizedProfit(range){
  const sold = readSold();
  const today = startOfToday();
  let minDate = null;

  if (range === "ytd") {
    minDate = new Date(today.getFullYear(), 0, 1);
  } else if (range === "30") {
    minDate = new Date(today);
    minDate.setDate(minDate.getDate() - 30);
  }

  return sold.reduce((sum, r)=>{
    const p = Number(r.profit)||0;
    if (!minDate) return sum + p;
    const d = parseDateSafe(r.date);
    if (!d) return sum + p; // if missing date, still count it
    return (d >= minDate) ? sum + p : sum;
  }, 0);
}

function updateNetWorth(){
  const panel = document.getElementById("netWorthPanel");
  if (!panel) return;

  const showToggle = document.getElementById("nwShowToggle");
  const consToggle = document.getElementById("nwConservativeToggle");
  const rangeSel = document.getElementById("nwRange");

  const show = showToggle ? !!showToggle.checked : true;
  panel.classList.toggle("is-hidden", !show);

  const conservative = consToggle ? !!consToggle.checked : false;
  const range = rangeSel ? rangeSel.value : "all";

  const { invCost, invValue } = sumActiveValue(conservative);
  const realized = sumRealizedProfit(range);

  const unrealized = invValue - invCost;
  const netWorth = invValue + realized;

  const setText = (id, val) => {
    const el = document.getElementById(id);
    if (el) el.textContent = val;
  };

  setText("nwInvValue", formatDollars(invValue));
  setText("nwInvCost", formatDollars(invCost));
  setText("nwUnrealized", formatDollars(unrealized));
  setText("nwRealized", formatDollars(realized));
  setText("nwTotal", formatDollars(netWorth));
  const asOf = document.getElementById("nwAsOf");
  if (asOf) asOf.textContent = `As of ${new Date().toLocaleString()}`;

  // color the total
  const totalEl = document.getElementById("nwTotal");
  if (totalEl){
    totalEl.classList.remove("nw-pos","nw-neg");
    if (netWorth > 0) totalEl.classList.add("nw-pos");
    if (netWorth < 0) totalEl.classList.add("nw-neg");
  }
}

function initNetWorthUI(){
  const showToggle = document.getElementById("nwShowToggle");
  const consToggle = document.getElementById("nwConservativeToggle");
  const rangeSel = document.getElementById("nwRange");

  // restore saved preferences
  if (showToggle){
    const saved = localStorage.getItem(NW_SHOW_KEY);
    showToggle.checked = saved === null ? true : (saved === "1");
    showToggle.addEventListener("change", ()=>{
      localStorage.setItem(NW_SHOW_KEY, showToggle.checked ? "1" : "0");
      updateNetWorth();
    });
  }
  if (consToggle){
    const saved = localStorage.getItem(NW_CONS_KEY);
    consToggle.checked = saved === "1";
    consToggle.addEventListener("change", ()=>{
      localStorage.setItem(NW_CONS_KEY, consToggle.checked ? "1" : "0");
      updateNetWorth();
    });
  }
  if (rangeSel){
    rangeSel.addEventListener("change", updateNetWorth);
  }

  updateNetWorth();
}






/* ========= NEXT MONTH INVENTORY BUDGET ========= */
function _getNextMonthLabel(d){
  const nm = new Date(d.getFullYear(), d.getMonth()+1, 1);
  return nm.toLocaleString(undefined,{month:'long', year:'numeric'});
}
function _parseDateSafe(ds){
  if(!ds) return null;
  if(ds instanceof Date) return isNaN(ds.getTime())?null:ds;
  const s = String(ds).trim();
  let d = new Date(s);
  if(!isNaN(d.getTime())) return d;
  let m = s.match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})$/);
  if(m){ d=new Date(+m[3], +m[1]-1, +m[2]); if(!isNaN(d.getTime())) return d; }
  m = s.match(/^(\d{4})-(\d{1,2})-(\d{1,2})$/);
  if(m){ d=new Date(+m[1], +m[2]-1, +m[3]); if(!isNaN(d.getTime())) return d; }
  return null;
}
function _sumSoldForMonth(rows, y, m){
  let sales=0, profit=0;
  (rows||[]).forEach(r=>{
    const dt=_parseDateSafe(r.date||r.soldDate||r.sold_date||r.saleDate||'');
    if(!dt) return;
    if(dt.getFullYear()!=y || dt.getMonth()!=m) return;
    const sale=Number(r.sale||r.price||0)||0;
    const cost=Number(r.cost||0)||0;
    const fees=Number(r.fees||0)||0;
    const ship=Number(r.shipping||r.ship||0)||0;
    sales += sale;
    profit += (sale - cost - fees - ship);
  });
  return {sales, profit};
}
function updateBudgetPanel(){
  const panel=document.getElementById('budgetPanel');
  if(!panel) return;
  const sold = (typeof readSold==='function') ? readSold() : (JSON.parse(localStorage.getItem('soldInventory')||'[]')||[]);

  const now=new Date();
  const y=now.getFullYear();
  const m=now.getMonth();
  const day=now.getDate();
  const daysInMonth=new Date(y, m+1, 0).getDate();

  const sums=_sumSoldForMonth(sold, y, m);
  const mtdSales=sums.sales;
  const mtdProfit=sums.profit;
  const pace = day>0 ? (mtdSales/day) : 0;
  const projSales = pace * daysInMonth;

  const pctEl=document.getElementById('reinvestPct');
  const pctLabel=document.getElementById('reinvestPctLabel');
  const modeEl=document.getElementById('budgetMode');
  let pct=50;
  if(pctEl) pct = parseInt(pctEl.value||'50',10)||50;
  if(pctLabel) pctLabel.textContent = pct+'%';
  try{ localStorage.setItem('resellr_reinvest_pct', String(pct)); }catch(e){}

  const mode = modeEl ? modeEl.value : 'projected';
  const baseSales = (mode==='mtd') ? mtdSales : projSales;
  const nextBudget = baseSales * (pct/100);

  const monthPill=document.getElementById('budgetMonthPill');
  if(monthPill) monthPill.textContent = 'For ' + _getNextMonthLabel(now);

  const setText=(id, txt)=>{ const el=document.getElementById(id); if(el) el.textContent=txt; };
  if(typeof formatDollars==='function'){
    setText('mtdSalesStat', 'MTD SALES: ' + formatDollars(mtdSales));
    setText('mtdProfitStat','MTD PROFIT: ' + formatDollars(mtdProfit));
    setText('projSalesStat','PROJ SALES: ' + formatDollars(projSales));
    setText('nextBudgetStat','NEXT BUDGET: ' + formatDollars(nextBudget));
  }else{
    const fd=(v)=>'$'+(Math.round((v||0)*100)/100).toLocaleString();
    setText('mtdSalesStat', 'MTD SALES: ' + fd(mtdSales));
    setText('mtdProfitStat','MTD PROFIT: ' + fd(mtdProfit));
    setText('projSalesStat','PROJ SALES: ' + fd(projSales));
    setText('nextBudgetStat','NEXT BUDGET: ' + fd(nextBudget));
  }

  const fill=document.getElementById('monthProgressFill');
  const lbl=document.getElementById('monthProgressLabel');
  const pctMonth=Math.max(0, Math.min(100, (day/daysInMonth)*100));
  if(fill) fill.style.width = pctMonth.toFixed(0)+'%';
  if(lbl) lbl.textContent = day+' / '+daysInMonth+' days ('+pctMonth.toFixed(0)+'%) ‚Ä¢ Mode: ' + (mode==='mtd'?'If month ended today':'Projected at current pace');
}
function safeBudgetRefresh(){ try{ updateBudgetPanel(); }catch(e){} }

function initBudgetPanel(){
  const pctEl=document.getElementById('reinvestPct');
  const modeEl=document.getElementById('budgetMode');
  try{ const saved=localStorage.getItem('resellr_reinvest_pct'); if(saved && pctEl) pctEl.value=saved; }catch(e){}
  if(pctEl) pctEl.addEventListener('input', updateBudgetPanel);
  if(modeEl) modeEl.addEventListener('change', updateBudgetPanel);
  updateBudgetPanel();
}


/* ========= BOOT ========= */
window.onload = () => {
  initLock();

  earningsBalance.value = localStorage.getItem("earningsBalance") || "";
  inventoryAllowance.value = localStorage.getItem("inventoryAllowance") || "";

  updateBalanceStats();
  renderActive();
  renderSold();
  loadIncomeChart();
  initBudgetPanel();
  showSection('secDashboard');
};

</script>

</body>
</html>
